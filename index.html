<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi V√©hicules - Gaz Service</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 3px solid #ecf0f1;
            flex-wrap: wrap;
        }

        .tab {
            padding: 15px 25px;
            background: #ecf0f1;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 5px;
            margin-bottom: 5px;
            border-radius: 8px 8px 0 0;
        }

        .tab.active {
            background: #3498db;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .checkbox-item:hover {
            background: #e9ecef;
        }

        .checkbox-item.checked {
            background: #d4edda;
            border-color: #28a745;
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .state-group {
            margin: 20px 0;
        }

        .state-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .state-item {
            display: flex;
            flex-direction: column;
        }

        .state-item select {
            padding: 12px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            background: white;
            min-height: 48px;
        }

        .state-item select:focus {
            outline: none;
            border-color: #3498db;
        }

        .state-item label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .btn {
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
            transform: translateY(-2px);
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .controls-list {
            margin-top: 30px;
        }

        .control-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .control-item:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .control-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .control-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .control-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-weight: 600;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .info-value {
            color: #2c3e50;
            margin-top: 2px;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-ok {
            background: #d4edda;
            color: #155724;
        }

        .status-missing {
            background: #f8d7da;
            color: #721c24;
        }

        .status-bon {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-moyen {
            background: #fff3cd;
            color: #856404;
        }

        .status-mauvais {
            background: #f8d7da;
            color: #721c24;
        }

        .no-data {
            text-align: center;
            padding: 50px;
            color: #6c757d;
        }

        .search-bar {
            margin-bottom: 20px;
        }

        .search-bar input {
            width: 100%;
            padding: 12px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 1rem;
        }

        .backup-section {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .backup-section h4 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .backup-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            align-items: center;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            overflow: hidden;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: inline-block;
            padding: 12px 20px;
            background: #6c757d;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .file-input-label:hover {
            background: #5a6268;
        }

        /* Import section sp√©cifique */
        .import-individual-section {
            background: #f0f8ff;
            border: 2px dashed #007bff;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
        }

        .import-individual-section.drag-over {
            border-color: #28a745;
            background: #f0fff4;
        }

        .import-preview {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
            display: none;
        }

        .import-preview h5 {
            color: #2c3e50;
            margin-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 10px;
        }

        .import-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .import-preview-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }

        .import-preview-label {
            font-weight: 600;
            font-size: 0.9rem;
            color: #6c757d;
        }

        .import-preview-value {
            color: #2c3e50;
            margin-top: 3px;
        }

        /* Styles pour le module photo */
        .photo-section {
            margin: 30px 0;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 2px dashed #007bff;
        }

        .photo-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .photo-counter {
            font-weight: 600;
            color: #6c757d;
            background: #e9ecef;
            padding: 8px 12px;
            border-radius: 20px;
        }

        .photo-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .photo-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .photo-item:hover {
            transform: translateY(-2px);
        }

        .photo-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }

        .photo-delete {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .photo-delete:hover {
            background: #c0392b;
        }

        /* Modal cam√©ra */
        .camera-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .camera-content {
            background: white;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .camera-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #3498db;
            color: white;
            flex-shrink: 0;
        }

        .camera-header h4 {
            margin: 0;
        }

        .camera-body {
            padding: 15px 20px;
            text-align: center;
            flex: 1;
            overflow: auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .camera-body video {
            width: 100%;
            max-width: 450px;
            max-height: 60vh;
            border-radius: 8px;
            background: #000;
        }

        .camera-footer {
            padding: 15px 20px;
            text-align: center;
            background: #f8f9fa;
            flex-shrink: 0;
            border-top: 1px solid #dee2e6;
        }

        /* Affichage des photos dans l'historique */
        .control-photos {
            margin-top: 15px;
        }

        .control-photos h5 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .photos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
        }

        .photo-thumbnail {
            width: 100%;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .photo-thumbnail:hover {
            transform: scale(1.05);
        }

        /* Modal d'agrandissement des photos */
        .photo-viewer-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1100;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .photo-viewer-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }

        .photo-viewer-image {
            max-width: 100%;
            max-height: 100%;
            border-radius: 8px;
        }

        .photo-viewer-close {
            position: absolute;
            top: -40px;
            right: 0;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 1.2rem;
        }

        /* Styles pour les alertes */
        .alert-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 5px solid transparent;
        }

        .stat-card.total {
            border-left-color: #3498db;
        }

        .stat-card.resolved {
            border-left-color: #27ae60;
        }

        .stat-card.critical {
            border-left-color: #e74c3c;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .alerts-list {
            margin-top: 20px;
        }

        .alert-item {
            background: white;
            border: 1px solid #dee2e6;
            border-left: 5px solid #dc3545;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            position: relative;
        }

        .alert-item:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .alert-item.resolved {
            border-left-color: #28a745;
            background: #f8fff9;
            opacity: 0.8;
        }

        .alert-item.critical {
            border-left-color: #dc3545;
            background: #fff5f5;
        }

        .alert-item.warning {
            border-left-color: #ffc107;
            background: #fffdf0;
        }

        .alert-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .alert-title {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .alert-vehicle {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .alert-date {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .alert-severity {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .alert-severity.critical {
            background: #f8d7da;
            color: #721c24;
        }

        .alert-severity.warning {
            background: #fff3cd;
            color: #856404;
        }

        .alert-severity.resolved {
            background: #d4edda;
            color: #155724;
        }

        .alert-content {
            margin-bottom: 15px;
        }

        .alert-issues {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .alert-category {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 12px;
        }

        .alert-category h5 {
            margin: 0 0 8px 0;
            color: #495057;
            font-size: 0.9rem;
        }

        .alert-issue {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.85rem;
        }

        .alert-issue:last-child {
            border-bottom: none;
        }

        .issue-name {
            flex: 1;
            color: #495057;
        }

        .issue-status {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .issue-status.missing {
            background: #f8d7da;
            color: #721c24;
        }

        .issue-status.bad {
            background: #fff3cd;
            color: #856404;
        }

        .alert-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .alert-filters {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #c3e6cb;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
        }

        .warning-message {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #ffeaa7;
        }

        .info-message {
            background: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #bee5eb;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .main-content {
                padding: 20px;
            }

            .form-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .tabs {
                flex-direction: column;
            }

            .tab {
                margin-right: 0;
                border-radius: 8px;
            }

            .checkbox-group {
                grid-template-columns: 1fr;
            }

            .control-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .control-actions {
                width: 100%;
                justify-content: flex-start;
            }

            .btn {
                padding: 12px 20px;
                font-size: 1rem;
                margin: 5px 5px 5px 0;
            }

            .backup-controls {
                grid-template-columns: 1fr;
            }

            .photo-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .photo-preview {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 10px;
            }

            .camera-content {
                width: 95%;
                margin: 10px;
            }

            .camera-header {
                padding: 15px;
            }

            .camera-body {
                padding: 15px;
            }

            .photos-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            }

            .photo-thumbnail {
                height: 60px;
            }

            .alert-stats {
                grid-template-columns: 1fr;
            }

            .alert-header {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }

            .alert-actions {
                flex-direction: column;
            }

            .alert-issues {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöó Suivi des V√©hicules</h1>
            <p>Gaz Service - Contr√¥le et maintenance v4.0 (Export/Import Individuels)</p>
        </div>

        <div class="main-content">
            <div class="tabs">
                <button class="tab active" onclick="showTab('nouveau')">Nouveau Contr√¥le</button>
                <button class="tab" onclick="showTab('historique')">Historique</button>
                <button class="tab" onclick="showTab('import-individuel')">üì• Import Contr√¥les</button>
                <button class="tab" onclick="showTab('alertes')">‚ö†Ô∏è Alertes</button>
                <button class="tab" onclick="showTab('avancement')">Suivi Avancement</button>
                <button class="tab" onclick="showTab('sauvegarde')">Sauvegarde</button>
                <button class="tab" onclick="showTab('export')">Export Excel</button>
                <button class="tab" onclick="showTab('pdf')">Export PDF</button>
                <button class="tab" onclick="showTab('maintenance')">üîß Maintenance</button>
            </div>

            <!-- Onglet Nouveau Contr√¥le -->
            <div id="nouveau" class="tab-content active">
                <form id="vehicleForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="conducteur">Nom du conducteur *</label>
                            <input type="text" id="conducteur" name="conducteur" required 
                                   oninput="formatConducteurName(this)" 
                                   style="text-transform: uppercase;">
                        </div>
                        <div class="form-group">
                            <label for="dateControle">Date du contr√¥le *</label>
                            <input type="date" id="dateControle" name="dateControle" required>
                        </div>
                        <div class="form-group">
                            <label for="immatriculation">Immatriculation *</label>
                            <input type="text" id="immatriculation" name="immatriculation" 
                                   placeholder="XX-XXX-DZ" required 
                                   oninput="formatImmatriculation(this)" 
                                   maxlength="9" 
                                   style="text-transform: uppercase;">
                        </div>
                        <div class="form-group">
                            <label for="kilometrage">Kilom√©trage</label>
                            <input type="number" id="kilometrage" name="kilometrage" placeholder="123456">
                        </div>
                        <div class="form-group">
                            <label for="prochainControle">Prochain contr√¥le technique</label>
                            <input type="date" id="prochainControle" name="prochainControle">
                        </div>
                        <div class="form-group">
                            <label for="derniereRevision">Derni√®re r√©vision (km)</label>
                            <input type="number" id="derniereRevision" name="derniereRevision" placeholder="ex: 120000">
                        </div>
                        <div class="form-group">
                            <label for="commentaires">üí¨ Commentaires et observations</label>
                            <textarea id="commentaires" name="commentaires" rows="3" placeholder="Ajoutez vos observations, remarques ou notes concernant ce contr√¥le..."></textarea>
                        </div>
                    </div>

                    <h3>üìã Documents obligatoires</h3>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="permis" name="permis">
                            <label for="permis">Permis de conduire</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="carteVerte" name="carteVerte">
                            <label for="carteVerte">Carte verte (assurance)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="carteGrise" name="carteGrise">
                            <label for="carteGrise">Carte grise</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="carteCarburant" name="carteCarburant">
                            <label for="carteCarburant">Carte carburant</label>
                        </div>
                    </div>

                    <h3>üõ°Ô∏è √âquipements de s√©curit√©</h3>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="giletJaune" name="giletJaune">
                            <label for="giletJaune">Gilet jaune</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="triangle" name="triangle">
                            <label for="triangle">Triangle de signalisation</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="roueSecours" name="roueSecours">
                            <label for="roueSecours">Roue de secours</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="trousseSecours" name="trousseSecours">
                            <label for="trousseSecours">Trousse de secours</label>
                        </div>
                    </div>

                    <h3>üîß √âtat g√©n√©ral</h3>
                    <div class="state-group">
                        <div class="state-grid">
                            <div class="state-item">
                                <label>Rangement du v√©hicule</label>
                                <select name="etatRangement">
                                    <option value="bon">Bon</option>
                                    <option value="moyen">Moyen</option>
                                    <option value="mauvais">Mauvais</option>
                                </select>
                            </div>
                            <div class="state-item">
                                <label>Propret√© int√©rieur</label>
                                <select name="propreteInterieur">
                                    <option value="bon">Bon</option>
                                    <option value="moyen">Moyen</option>
                                    <option value="mauvais">Mauvais</option>
                                </select>
                            </div>
                            <div class="state-item">
                                <label>Propret√© ext√©rieur</label>
                                <select name="propreteExterieur">
                                    <option value="bon">Bon</option>
                                    <option value="moyen">Moyen</option>
                                    <option value="mauvais">Mauvais</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <h3>üõû √âtat des pneus</h3>
                    <div class="state-group">
                        <div class="state-grid">
                            <div class="state-item">
                                <label>Pneu avant gauche</label>
                                <select name="pneuAvantGauche">
                                    <option value="bon">Bon</option>
                                    <option value="moyen">Moyen</option>
                                    <option value="mauvais">Mauvais</option>
                                </select>
                            </div>
                            <div class="state-item">
                                <label>Pneu avant droit</label>
                                <select name="pneuAvantDroit">
                                    <option value="bon">Bon</option>
                                    <option value="moyen">Moyen</option>
                                    <option value="mauvais">Mauvais</option>
                                </select>
                            </div>
                            <div class="state-item">
                                <label>Pneu arri√®re gauche</label>
                                <select name="pneuArriereGauche">
                                    <option value="bon">Bon</option>
                                    <option value="moyen">Moyen</option>
                                    <option value="mauvais">Mauvais</option>
                                </select>
                            </div>
                            <div class="state-item">
                                <label>Pneu arri√®re droit</label>
                                <select name="pneuArriereDroit">
                                    <option value="bon">Bon</option>
                                    <option value="moyen">Moyen</option>
                                    <option value="mauvais">Mauvais</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <h3>üì∏ Photos du contr√¥le</h3>
                    <div class="photo-section">
                        <p style="color: #6c757d; margin-bottom: 15px;">
                            Prenez jusqu'√† 5 photos pour documenter l'√©tat du v√©hicule
                        </p>
                        
                        <div class="photo-controls">
                            <button type="button" class="btn btn-info" onclick="openCamera()" id="cameraBtn">
                                üì± Prendre une photo
                            </button>
                            <span id="photoCount" class="photo-counter">0/5 photos</span>
                        </div>

                        <div id="photoPreview" class="photo-preview">
                            <!-- Photos will be displayed here -->
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 30px;">
                        <button type="submit" class="btn btn-primary">üíæ Enregistrer le contr√¥le</button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">üîÑ R√©initialiser</button>
                    </div>
                </form>
            </div>

            <!-- Onglet Historique -->
            <div id="historique" class="tab-content">
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="üîç Rechercher par immatriculation, conducteur..." onkeyup="filterControls()">
                </div>
                <div id="controlsList" class="controls-list">
                    <div class="no-data">
                        <h3>Aucun contr√¥le enregistr√©</h3>
                        <p>Commencez par ajouter un nouveau contr√¥le</p>
                    </div>
                </div>
            </div>

            <!-- NOUVEL ONGLET : Import Contr√¥les Individuels -->
            <div id="import-individuel" class="tab-content">
                <div style="padding: 20px;">
                    <h3>üì• Import de Contr√¥les Individuels</h3>
                    <p style="margin: 15px 0; color: #6c757d;">
                        Importez des contr√¥les depuis des fichiers JSON g√©n√©r√©s par l'export individuel.
                    </p>

                    <!-- Section d'import -->
                    <div class="import-individual-section" id="importIndividualSection">
                        <div class="import-instructions">
                            <h4>üìã Importation de Contr√¥le</h4>
                            <p>Glissez-d√©posez votre fichier JSON de contr√¥le ou cliquez pour le s√©lectionner</p>
                        </div>
                        
                        <div class="file-input-wrapper">
                            <input type="file" id="individualControlFile" accept=".json" onchange="handleIndividualControlFile(this)">
                            <label for="individualControlFile" class="file-input-label">
                                üìÇ S√©lectionner le fichier JSON
                            </label>
                        </div>
                    </div>

                    <!-- Pr√©visualisation -->
                    <div id="importPreview" class="import-preview">
                        <h5>üìã Aper√ßu du contr√¥le √† importer</h5>
                        <div id="importPreviewContent"></div>
                    </div>

                    <!-- Actions -->
                    <div style="text-align: center; margin: 20px 0;">
                        <button class="btn btn-success" onclick="importIndividualControl()" id="importIndividualBtn" disabled>
                            ‚¨ÜÔ∏è Importer le contr√¥le
                        </button>
                        <button class="btn btn-warning" onclick="clearImportPreview()">
                            üîÑ Annuler
                        </button>
                    </div>

                    <div id="importIndividualStatus"></div>
                </div>
            </div>

            <!-- Onglet Alertes -->
            <div id="alertes" class="tab-content">
                <div style="padding: 20px;">
                    <h3>‚ö†Ô∏è Gestion des Alertes</h3>
                    <p style="margin: 15px 0; color: #6c757d;">
                        Suivi des anomalies d√©tect√©es lors des contr√¥les v√©hicules (√©l√©ments absents ou en mauvais √©tat).
                    </p>

                    <!-- Statistiques des alertes -->
                    <div class="alert-stats" id="alertStats" style="display: none;">
                        <div class="stat-card total">
                            <div class="stat-number" id="totalAlerts">0</div>
                            <div class="stat-label">Alertes actives</div>
                        </div>
                        <div class="stat-card resolved">
                            <div class="stat-number" id="resolvedAlerts">0</div>
                            <div class="stat-label">Alertes r√©solues</div>
                        </div>
                        <div class="stat-card critical">
                            <div class="stat-number" id="criticalAlerts">0</div>
                            <div class="stat-label">Alertes critiques</div>
                        </div>
                    </div>

                    <!-- Filtres -->
                    <div class="alert-filters" style="margin: 20px 0;">
                        <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                            <div class="form-group">
                                <label for="alertStatusFilter">Statut des alertes</label>
                                <select id="alertStatusFilter" onchange="filterAlerts()">
                                    <option value="all">Toutes les alertes</option>
                                    <option value="active" selected>Alertes actives</option>
                                    <option value="resolved">Alertes r√©solues</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="alertTypeFilter">Type d'alerte</label>
                                <select id="alertTypeFilter" onchange="filterAlerts()">
                                    <option value="all">Tous les types</option>
                                    <option value="document">Documents manquants</option>
                                    <option value="equipment">√âquipements manquants</option>
                                    <option value="condition">√âtats d√©grad√©s</option>
                                </select>
                            </div>
                            <div class="form-group" style="display: flex; align-items: end;">
                                <button class="btn btn-primary" onclick="refreshAlerts()">
                                    üîÑ Actualiser
                                </button>
                            </div>
                        </div>
                        
                        <div class="search-bar" style="margin-top: 15px;">
                            <input type="text" id="alertSearchInput" placeholder="üîç Rechercher par immatriculation, conducteur..." onkeyup="filterAlerts()">
                        </div>
                    </div>

                    <!-- Liste des alertes -->
                    <div id="alertsList" class="alerts-list">
                        <div class="no-data">
                            <h3>Aucune alerte d√©tect√©e</h3>
                            <p>Parfait ! Tous les contr√¥les sont conformes.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Onglet Suivi Avancement -->
            <div id="avancement" class="tab-content">
                <div style="padding: 20px;">
                    <h3>üìä Suivi d'avancement des contr√¥les</h3>
                    <p style="margin: 15px 0; color: #6c757d;">
                        Importez votre liste de v√©hicules et suivez l'avancement des contr√¥les effectu√©s.
                    </p>

                    <!-- Information sur la r√®gle des 35 jours -->
                    <div class="expiry-info" style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px; padding: 12px; margin-bottom: 20px; font-size: 0.9rem;">
                        <h5 style="color: #856404; margin-bottom: 8px;">‚è∞ R√®gle de validit√© des contr√¥les</h5>
                        <p style="color: #856404; margin: 0;">Un contr√¥le n'est consid√©r√© comme "Contr√¥l√©" que s'il a √©t√© effectu√© dans les 35 derniers jours. Au-del√†, le v√©hicule repasse automatiquement au statut "En attente".</p>
                    </div>

                    <!-- Import de fichier Excel -->
                    <div class="import-individual-section" id="importVehicleSection">
                        <div class="import-instructions">
                            <h4>üìã Importation de la liste des v√©hicules</h4>
                            <p>Glissez-d√©posez votre fichier Excel (.xlsx) ou cliquez pour le s√©lectionner</p>
                            <div style="background: white; border: 1px solid #dee2e6; border-radius: 6px; padding: 15px; margin: 15px 0; font-family: monospace; text-align: left;">
                                <div style="font-weight: bold; background: #f8f9fa; padding: 5px; margin: -5px; margin-bottom: 10px;">Format attendu du fichier Excel :</div>
                                <div style="padding: 3px 0; border-bottom: 1px solid #f1f3f4;">Colonne A : Immatriculation (ex: AB-123-CD)</div>
                                <div style="padding: 3px 0; border-bottom: 1px solid #f1f3f4;">Colonne B : Marque (ex: Peugeot)</div>
                                <div style="padding: 3px 0;">Colonne C : Mod√®le (ex: 308)</div>
                            </div>
                        </div>
                        
                        <div class="file-input-wrapper">
                            <input type="file" id="vehicleListFile" accept=".xlsx,.xls" onchange="handleVehicleListFile(this)">
                            <label for="vehicleListFile" class="file-input-label">
                                üìÇ S√©lectionner le fichier Excel
                            </label>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <button class="btn btn-success" onclick="importVehicleList()" id="importVehicleBtn" disabled>
                                ‚¨ÜÔ∏è Importer la liste
                            </button>
                            <button class="btn btn-danger" onclick="clearVehicleList()">
                                üóëÔ∏è Vider la liste
                            </button>
                        </div>
                    </div>

                    <!-- Statistiques d'avancement -->
                    <div class="alert-stats" id="progressStats" style="display: none;">
                        <div class="stat-card" style="border-left-color: #3498db;">
                            <div class="stat-number" id="totalVehicles">0</div>
                            <div class="stat-label">Total v√©hicules</div>
                        </div>
                        <div class="stat-card" style="border-left-color: #27ae60;">
                            <div class="stat-number" id="controlledVehicles">0</div>
                            <div class="stat-label">Contr√¥l√©s (< 35j)</div>
                        </div>
                        <div class="stat-card" style="border-left-color: #ff6b6b;">
                            <div class="stat-number" id="expiredVehicles">0</div>
                            <div class="stat-label">Expir√©s (> 35j)</div>
                        </div>
                        <div class="stat-card" style="border-left-color: #e74c3c;">
                            <div class="stat-number" id="pendingVehicles">0</div>
                            <div class="stat-label">En attente</div>
                        </div>
                        <div class="stat-card" style="border-left-color: #f39c12;">
                            <div class="stat-number" id="completionPercent">0%</div>
                            <div class="stat-label">Avancement</div>
                            <div style="width: 100%; height: 8px; background: #ecf0f1; border-radius: 4px; overflow: hidden; margin: 10px 0;">
                                <div id="progressFill" style="height: 100%; background: linear-gradient(90deg, #27ae60, #2ecc71); transition: width 0.3s ease; width: 0%;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Liste des v√©hicules -->
                    <div id="vehicleListContainer" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap;">
                            <h4>üöó Liste des v√©hicules</h4>
                            <button class="btn btn-success" onclick="exportProgressToExcel()">
                                üìä Exporter le suivi
                            </button>
                        </div>
                        
                        <div class="search-bar">
                            <input type="text" id="vehicleSearchInput" placeholder="üîç Rechercher un v√©hicule..." onkeyup="filterVehicleList()">
                        </div>
                        
                        <div id="vehicleList" class="vehicle-list" style="margin-top: 20px;">
                            <!-- Liste des v√©hicules sera g√©n√©r√©e ici -->
                        </div>
                    </div>

                    <div id="progressStatus"></div>
                </div>
            </div>

            <!-- Onglet Sauvegarde -->
            <div id="sauvegarde" class="tab-content">
                <div style="padding: 20px;">
                    <h3>üíæ Gestion des sauvegardes</h3>
                    <p style="margin: 15px 0; color: #6c757d;">
                        Prot√©gez vos donn√©es en cr√©ant des sauvegardes r√©guli√®res.
                    </p>

                    <!-- Sauvegarde manuelle -->
                    <div class="backup-section">
                        <h4>üíæ Sauvegarde manuelle</h4>
                        <div class="backup-controls">
                            <div>
                                <button class="btn btn-success" onclick="createManualBackup()">
                                    üíæ Cr√©er une sauvegarde
                                </button>
                            </div>
                        </div>
                        <div id="manualBackupStatus"></div>
                    </div>

                    <!-- Restauration -->
                    <div class="backup-section">
                        <h4>üìÇ Restaurer une sauvegarde</h4>
                        <div class="warning-message" style="margin-bottom: 15px;">
                            ‚ö†Ô∏è Attention : La restauration effacera toutes les donn√©es actuelles.
                        </div>
                        <div class="backup-controls">
                            <div class="file-input-wrapper">
                                <input type="file" id="backupFile" accept=".json" onchange="handleBackupFile(this)">
                                <label for="backupFile" class="file-input-label">
                                    üìã S√©lectionner un fichier de sauvegarde
                                </label>
                            </div>
                            <div>
                                <button class="btn btn-warning" onclick="restoreBackup()" id="restoreBtn" disabled>
                                    üîÑ Restaurer la sauvegarde
                                </button>
                            </div>
                        </div>
                        <div id="restoreStatus"></div>
                    </div>
                </div>
            </div>

            <!-- Onglet Export -->
            <div id="export" class="tab-content">
                <div style="text-align: center; padding: 40px;">
                    <h3>üìä Exporter les donn√©es</h3>
                    <p style="margin: 20px 0;">T√©l√©chargez tous les contr√¥les au format Excel (XLSX)</p>
                    <div class="loading" id="exportLoading">
                        <div class="spinner"></div>
                        <p>G√©n√©ration du fichier Excel...</p>
                    </div>
                    <button class="btn btn-success" onclick="exportToExcel()">üì• T√©l√©charger Excel</button>
                    <div id="exportStatus"></div>
                </div>
            </div>

            <!-- Onglet Export PDF -->
            <div id="pdf" class="tab-content">
                <div style="padding: 20px;">
                    <h3>üìÑ Export PDF des contr√¥les</h3>
                    <p style="margin: 15px 0; color: #6c757d;">
                        G√©n√©rez des rapports PDF individuels pour chaque contr√¥le.
                    </p>

                    <!-- Filtres -->
                    <div class="backup-section" style="background: #f8f9fa; border: 2px solid #dee2e6;">
                        <h4>üìÖ Filtres de p√©riode</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div class="form-group">
                                <label for="pdfDateDebut">Date de d√©but</label>
                                <input type="date" id="pdfDateDebut" name="pdfDateDebut">
                            </div>
                            <div class="form-group">
                                <label for="pdfDateFin">Date de fin</label>
                                <input type="date" id="pdfDateFin" name="pdfDateFin">
                            </div>
                            <div class="form-group" style="display: flex; align-items: end;">
                                <button class="btn btn-primary" onclick="filterControlsForPDF()">
                                    üîç Filtrer les contr√¥les
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- R√©sultats -->
                    <div id="pdfResults" style="margin-top: 20px; display: none;">
                        <h4>üìã Contr√¥les trouv√©s</h4>
                        <div id="pdfControlsList"></div>
                    </div>

                    <div class="loading" id="pdfLoading">
                        <div class="spinner"></div>
                        <p>G√©n√©ration du PDF en cours...</p>
                    </div>

                    <div id="pdfStatus"></div>
                </div>
            </div>

            <!-- Onglet Maintenance -->
            <div id="maintenance" class="tab-content">
                <div style="padding: 20px;">
                    <h3>üîß Maintenance du Syst√®me</h3>
                    <p style="margin: 15px 0; color: #6c757d;">
                        Outils de maintenance et de diagnostic pour r√©soudre les probl√®mes de donn√©es.
                    </p>

                    <!-- Diagnostic des doublons -->
                    <div class="backup-section">
                        <h4>üîç Diagnostic des Doublons d'Alertes</h4>
                        <p style="margin-bottom: 15px; color: #6c757d;">
                            D√©tectez et supprimez automatiquement les alertes en doublon.
                        </p>
                        <div class="backup-controls">
                            <div>
                                <button class="btn btn-info" onclick="diagnoseDuplicateAlerts()">
                                    üîç Analyser les doublons
                                </button>
                            </div>
                            <div>
                                <button class="btn btn-warning" onclick="removeDuplicateAlerts()">
                                    üóëÔ∏è Supprimer les doublons
                                </button>
                            </div>
                        </div>
                        <div id="duplicateStatus"></div>
                    </div>

                    <!-- R√©g√©n√©ration des alertes -->
                    <div class="backup-section">
                        <h4>‚ö° R√©g√©n√©ration des Alertes</h4>
                        <p style="margin-bottom: 15px; color: #6c757d;">
                            Supprimez toutes les alertes existantes et les r√©g√©n√®re √† partir des contr√¥les.
                        </p>
                        <div class="backup-controls">
                            <div>
                                <button class="btn btn-warning" onclick="regenerateAllAlerts()">
                                    ‚ö° R√©g√©n√©rer toutes les alertes
                                </button>
                            </div>
                        </div>
                        <div id="regenerateStatus"></div>
                    </div>

                    <!-- Nettoyage des orphelins -->
                    <div class="backup-section">
                        <h4>üßπ Nettoyage des Donn√©es Orphelines</h4>
                        <p style="margin-bottom: 15px; color: #6c757d;">
                            Supprimez les alertes qui ne correspondent plus √† aucun contr√¥le existant.
                        </p>
                        <div class="backup-controls">
                            <div>
                                <button class="btn btn-danger" onclick="cleanOrphanedAlerts()">
                                    üßπ Nettoyer les orphelins
                                </button>
                            </div>
                        </div>
                        <div id="cleanupStatus"></div>
                    </div>

                    <!-- Statistiques de la base -->
                    <div class="backup-section">
                        <h4>üìä Statistiques de la Base de Donn√©es</h4>
                        <div class="backup-controls">
                            <div>
                                <button class="btn btn-info" onclick="showDatabaseStats()">
                                    üìä Afficher les statistiques
                                </button>
                            </div>
                        </div>
                        <div id="statsStatus"></div>
                    </div>

                    <!-- R√©paration de la base -->
                    <div class="backup-section">
                        <h4>üîß R√©paration de la Base</h4>
                        <p style="margin-bottom: 15px; color: #6c757d;">
                            Effectue une v√©rification et r√©paration compl√®te de la base de donn√©es.
                        </p>
                        <div class="backup-controls">
                            <div>
                                <button class="btn btn-warning" onclick="repairDatabase()">
                                    üîß R√©parer la base
                                </button>
                            </div>
                        </div>
                        <div id="repairStatus"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Camera Modal -->
    <div id="cameraModal" class="camera-modal" style="display: none;">
        <div class="camera-content">
            <div class="camera-header">
                <h4>üì∏ Prendre une photo</h4>
                <button type="button" class="btn btn-danger" onclick="closeCamera()">‚úñ Fermer</button>
            </div>
            <div class="camera-body">
                <video id="cameraVideo" autoplay playsinline></video>
                <canvas id="photoCanvas" style="display: none;"></canvas>
            </div>
            <div class="camera-footer">
                <button type="button" class="btn btn-primary" onclick="takePhoto()">
                    üì∏ Capturer
                </button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let db;
        const DB_NAME = 'GazServiceVehicules';
        const DB_VERSION = 5;
        const STORE_NAME = 'controles';
        const ALERT_STORE_NAME = 'alertes';
        let selectedBackupFile = null;
        let selectedIndividualFile = null;
        let currentPhotos = [];
        let cameraStream = null;
        let currentAlerts = [];
        const MAX_PHOTOS = 5;

        // === INITIALISATION DE LA BASE DE DONN√âES ===
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    
                    // Store pour les contr√¥les
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const store = db.createObjectStore(STORE_NAME, { 
                            keyPath: 'id', 
                            autoIncrement: true 
                        });
                        store.createIndex('immatriculation', 'immatriculation', { unique: false });
                        store.createIndex('dateControle', 'dateControle', { unique: false });
                        store.createIndex('conducteur', 'conducteur', { unique: false });
                    }

                    // Store pour les alertes
                    if (!db.objectStoreNames.contains(ALERT_STORE_NAME)) {
                        const alertStore = db.createObjectStore(ALERT_STORE_NAME, { 
                            keyPath: 'id', 
                            autoIncrement: true 
                        });
                        alertStore.createIndex('controlId', 'controlId', { unique: false });
                        alertStore.createIndex('immatriculation', 'immatriculation', { unique: false });
                        alertStore.createIndex('status', 'status', { unique: false });
                        alertStore.createIndex('severity', 'severity', { unique: false });
                        alertStore.createIndex('type', 'type', { unique: false });
                    }
                };
            });
        }

        // === FONCTIONS DE FORMATAGE DES CHAMPS ===

        // Formatage automatique du nom du conducteur en majuscules
        function formatConducteurName(input) {
            const cursorPosition = input.selectionStart;
            const originalValue = input.value;
            
            // Convertir en majuscules
            input.value = input.value.toUpperCase();
            
            // Restaurer la position du curseur si elle a chang√©
            if (originalValue.length === input.value.length) {
                input.setSelectionRange(cursorPosition, cursorPosition);
            }
        }

        // Formatage automatique de l'immatriculation - Version sans manipulation de curseur
        function formatImmatriculation(input) {
            // R√©cup√©rer la valeur actuelle
            let value = input.value;
            
            // Supprimer tout sauf lettres et chiffres, convertir en majuscules
            let cleanValue = value.replace(/[^A-Z0-9]/gi, '').toUpperCase();
            
            // Limiter √† 7 caract√®res
            if (cleanValue.length > 7) {
                cleanValue = cleanValue.substring(0, 7);
            }
            
            // Appliquer le formatage selon la longueur
            let formattedValue = '';
            
            if (cleanValue.length <= 2) {
                formattedValue = cleanValue;
            } else if (cleanValue.length <= 5) {
                formattedValue = cleanValue.substring(0, 2) + '-' + cleanValue.substring(2);
            } else {
                formattedValue = cleanValue.substring(0, 2) + '-' + cleanValue.substring(2, 5) + '-' + cleanValue.substring(5);
            }
            
            // Mettre √† jour uniquement si la valeur a chang√©
            if (input.value !== formattedValue) {
                input.value = formattedValue;
            }
            
            // Validation visuelle
            validateImmatriculation(input);
        }

        // Validation simplifi√©e de l'immatriculation
        function validateImmatriculation(input) {
            const value = input.value;
            const isValid = /^[A-Z]{2}-[0-9]{3}-[A-Z]{2}$/.test(value);
            const length = value.replace(/-/g, '').length;
            
            // R√©initialiser les styles
            input.style.borderColor = '';
            input.style.backgroundColor = '';
            input.title = '';
            
            if (value.length === 0) {
                // Champ vide - style par d√©faut
                input.title = 'Saisir immatriculation format XX-XXX-XX';
            } else if (length < 7) {
                // En cours de saisie - orange
                input.style.borderColor = '#f39c12';
                input.style.backgroundColor = '#fff8e1';
                input.title = `En cours... (${length}/7 caract√®res)`;
            } else if (isValid) {
                // Valide - vert
                input.style.borderColor = '#27ae60';
                input.style.backgroundColor = '#d4edda';
                input.title = 'Format valide !';
            } else {
                // Invalide - rouge
                input.style.borderColor = '#e74c3c';
                input.style.backgroundColor = '#f8d7da';
                input.title = 'Format incorrect';
            }
        }

        // === FONCTIONS DE GESTION DES ALERTES ===

        // Sauvegarder une alerte
        function saveAlert(alertData) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([ALERT_STORE_NAME], 'readwrite');
                const store = transaction.objectStore(ALERT_STORE_NAME);
                const request = store.add(alertData);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // R√©cup√©rer toutes les alertes
        function getAllAlerts() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([ALERT_STORE_NAME], 'readonly');
                const store = transaction.objectStore(ALERT_STORE_NAME);
                const request = store.getAll();
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // Mettre √† jour une alerte
        function updateAlert(alertData) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([ALERT_STORE_NAME], 'readwrite');
                const store = transaction.objectStore(ALERT_STORE_NAME);
                const request = store.put(alertData);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // Supprimer les alertes li√©es √† un contr√¥le
        function deleteAlertsByControlId(controlId) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([ALERT_STORE_NAME], 'readwrite');
                const store = transaction.objectStore(ALERT_STORE_NAME);
                const index = store.index('controlId');
                const request = index.openCursor(controlId);
                
                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        cursor.delete();
                        cursor.continue();
                    } else {
                        resolve();
                    }
                };
                request.onerror = () => reject(request.error);
            });
        }

        // D√©tecter les anomalies dans un contr√¥le
        function detectAnomalies(control) {
            const anomalies = {
                documents: [],
                equipments: [],
                conditions: []
            };

            // V√©rifier les documents obligatoires
            const documents = {
                'permis': 'Permis de conduire',
                'carteVerte': 'Carte verte (assurance)',
                'carteGrise': 'Carte grise',
                'carteCarburant': 'Carte carburant'
            };

            Object.entries(documents).forEach(([key, label]) => {
                if (!control[key]) {
                    anomalies.documents.push({
                        item: label,
                        status: 'missing',
                        severity: 'critical'
                    });
                }
            });

            // V√©rifier les √©quipements de s√©curit√©
            const equipments = {
                'giletJaune': 'Gilet jaune',
                'triangle': 'Triangle de signalisation',
                'roueSecours': 'Roue de secours',
                'trousseSecours': 'Trousse de secours'
            };

            Object.entries(equipments).forEach(([key, label]) => {
                if (!control[key]) {
                    anomalies.equipments.push({
                        item: label,
                        status: 'missing',
                        severity: 'warning'
                    });
                }
            });

            // V√©rifier l'√©tat g√©n√©ral et des pneus
            const conditions = {
                'etatRangement': 'Rangement du v√©hicule',
                'propreteInterieur': 'Propret√© int√©rieur',
                'propreteExterieur': 'Propret√© ext√©rieur',
                'pneuAvantGauche': 'Pneu avant gauche',
                'pneuAvantDroit': 'Pneu avant droit',
                'pneuArriereGauche': 'Pneu arri√®re gauche',
                'pneuArriereDroit': 'Pneu arri√®re droit'
            };

            Object.entries(conditions).forEach(([key, label]) => {
                if (control[key] === 'mauvais') {
                    anomalies.conditions.push({
                        item: label,
                        status: 'bad',
                        severity: key.includes('pneu') ? 'critical' : 'warning'
                    });
                }
            });

            return anomalies;
        }

        // G√©n√©rer une alerte pour un contr√¥le sp√©cifique
        async function generateAlertsFromControl(controlId, controlData) {
            try {
                const anomalies = detectAnomalies(controlData);
                const totalIssues = anomalies.documents.length + anomalies.equipments.length + anomalies.conditions.length;
                
                // Supprimer les anciennes alertes pour ce contr√¥le
                await deleteAlertsByControlId(controlId);
                
                if (totalIssues > 0) {
                    // D√©terminer la s√©v√©rit√© globale
                    const hasCritical = [...anomalies.documents, ...anomalies.equipments, ...anomalies.conditions]
                        .some(issue => issue.severity === 'critical');
                    const overallSeverity = hasCritical ? 'critical' : 'warning';
                    
                    // D√©terminer le type principal
                    let primaryType = 'condition';
                    if (anomalies.documents.length > 0) primaryType = 'document';
                    else if (anomalies.equipments.length > 0) primaryType = 'equipment';

                    const alertData = {
                        controlId: controlId,
                        immatriculation: controlData.immatriculation,
                        conducteur: controlData.conducteur,
                        dateControle: controlData.dateControle,
                        severity: overallSeverity,
                        type: primaryType,
                        status: 'active',
                        issues: anomalies,
                        totalIssues: totalIssues,
                        dateCreated: new Date().toISOString(),
                        dateUpdated: new Date().toISOString(),
                        resolvedBy: null,
                        resolvedDate: null,
                        notes: ''
                    };

                    await saveAlert(alertData);
                }
                
            } catch (error) {
                console.error('Erreur lors de la g√©n√©ration de l\'alerte:', error);
                throw error;
            }
        }

        // FONCTION CORRIG√âE : Charger et afficher les alertes
        async function loadAlerts() {
            try {
                // NE PAS r√©g√©n√©rer automatiquement toutes les alertes
                // Juste r√©cup√©rer les alertes existantes
                const alerts = await getAllAlerts();
                currentAlerts = alerts;
                
                updateAlertStats(alerts);
                displayAlerts(alerts);
                
            } catch (error) {
                console.error('Erreur lors du chargement des alertes:', error);
                showMessage('error', 'Erreur lors du chargement des alertes : ' + error.message);
            }
        }

        // Mettre √† jour les statistiques des alertes
        function updateAlertStats(alerts) {
            const activeAlerts = alerts.filter(alert => alert.status === 'active');
            const resolvedAlerts = alerts.filter(alert => alert.status === 'resolved');
            const criticalAlerts = alerts.filter(alert => alert.severity === 'critical' && alert.status === 'active');

            document.getElementById('totalAlerts').textContent = activeAlerts.length;
            document.getElementById('resolvedAlerts').textContent = resolvedAlerts.length;
            document.getElementById('criticalAlerts').textContent = criticalAlerts.length;

            const statsContainer = document.getElementById('alertStats');
            if (alerts.length > 0) {
                statsContainer.style.display = 'grid';
            } else {
                statsContainer.style.display = 'none';
            }
        }

        // Afficher les alertes
        function displayAlerts(alerts) {
            const container = document.getElementById('alertsList');
            
            if (alerts.length === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        <h3>Aucune alerte d√©tect√©e</h3>
                        <p>Parfait ! Tous les contr√¥les sont conformes.</p>
                    </div>
                `;
                return;
            }

            // Trier les alertes par s√©v√©rit√© puis par date
            alerts.sort((a, b) => {
                if (a.status !== b.status) {
                    return a.status === 'active' ? -1 : 1;
                }
                if (a.severity !== b.severity) {
                    return a.severity === 'critical' ? -1 : 1;
                }
                return new Date(b.dateControle) - new Date(a.dateControle);
            });

            container.innerHTML = alerts.map(alert => createAlertCard(alert)).join('');
        }

        // Cr√©er une carte d'alerte
        function createAlertCard(alert) {
            const formatDate = (dateStr) => {
                return new Date(dateStr).toLocaleDateString('fr-FR');
            };

            const severityText = {
                'critical': 'Critique',
                'warning': 'Attention',
                'resolved': 'R√©solue'
            };

            const severityIcon = alert.severity === 'critical' ? 'üî¥' : 'üü°';
            const statusIcon = alert.status === 'resolved' ? '‚úÖ' : severityIcon;

            const issuesHtml = `
                ${alert.issues.documents.length > 0 ? `
                    <div class="alert-category">
                        <h5>üìã Documents manquants</h5>
                        ${alert.issues.documents.map(issue => `
                            <div class="alert-issue">
                                <span class="issue-name">${issue.item}</span>
                                <span class="issue-status missing">Absent</span>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                
                ${alert.issues.equipments.length > 0 ? `
                    <div class="alert-category">
                        <h5>üõ°Ô∏è √âquipements manquants</h5>
                        ${alert.issues.equipments.map(issue => `
                            <div class="alert-issue">
                                <span class="issue-name">${issue.item}</span>
                                <span class="issue-status missing">Absent</span>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                
                ${alert.issues.conditions.length > 0 ? `
                    <div class="alert-category">
                        <h5>üîß √âtats d√©grad√©s</h5>
                        ${alert.issues.conditions.map(issue => `
                            <div class="alert-issue">
                                <span class="issue-name">${issue.item}</span>
                                <span class="issue-status bad">Mauvais</span>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            `;

            const resolvedInfo = alert.status === 'resolved' ? `
                <div style="margin-top: 10px; padding: 10px; background: #d4edda; border-radius: 4px; font-size: 0.9rem;">
                    ‚úÖ R√©solue le ${formatDate(alert.resolvedDate)} ${alert.resolvedBy ? 'par ' + alert.resolvedBy : ''}
                    ${alert.notes ? `<br><em>${alert.notes}</em>` : ''}
                </div>
            ` : '';

            return `
                <div class="alert-item ${alert.status} ${alert.severity}" data-alert-id="${alert.id}" data-status="${alert.status}" data-type="${alert.type}">
                    <div class="alert-header">
                        <div class="alert-title">
                            <span>${statusIcon}</span>
                            <div>
                                <div class="alert-vehicle">${alert.immatriculation} - ${alert.conducteur}</div>
                                <div class="alert-date">Contr√¥le du ${formatDate(alert.dateControle)}</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <span class="alert-severity ${alert.status === 'resolved' ? 'resolved' : alert.severity}">
                                ${alert.status === 'resolved' ? 'R√©solue' : severityText[alert.severity]}
                            </span>
                            <span style="font-size: 0.8rem; color: #6c757d;">
                                ${alert.totalIssues} anomalie(s)
                            </span>
                        </div>
                    </div>

                    <div class="alert-content">
                        <div class="alert-issues">
                            ${issuesHtml}
                        </div>
                        ${resolvedInfo}
                    </div>

                    <div class="alert-actions">
                        ${alert.status === 'active' ? `
                            <button class="btn btn-success" onclick="resolveAlert(${alert.id})" style="padding: 8px 15px; font-size: 0.9rem;">
                                ‚úÖ R√©soudre
                            </button>
                        ` : `
                            <button class="btn btn-warning" onclick="unresolveAlert(${alert.id})" style="padding: 8px 15px; font-size: 0.9rem;">
                                üîÑ R√©activer
                            </button>
                        `}
                        <button class="btn btn-info" onclick="viewControlDetails(${alert.controlId})" style="padding: 8px 15px; font-size: 0.9rem;">
                            üëÅÔ∏è Voir contr√¥le
                        </button>
                        <button class="btn btn-secondary" onclick="addAlertNote(${alert.id})" style="padding: 8px 15px; font-size: 0.9rem;">
                            üìù Note
                        </button>
                    </div>
                </div>
            `;
        }

        // FONCTION CORRIG√âE : R√©soudre une alerte
        async function resolveAlert(alertId) {
            try {
                console.log('R√©solution de l\'alerte ID:', alertId);
                
                const alerts = await getAllAlerts();
                const alert = alerts.find(a => a.id === alertId);
                
                if (!alert) {
                    throw new Error('Alerte introuvable');
                }

                const resolvedBy = prompt('Votre nom (optionnel) :') || '';
                const notes = prompt('Notes sur la r√©solution (optionnel) :') || '';

                // Mettre √† jour l'alerte
                alert.status = 'resolved';
                alert.resolvedDate = new Date().toISOString();
                alert.resolvedBy = resolvedBy;
                alert.notes = notes;
                alert.dateUpdated = new Date().toISOString();

                console.log('Mise √† jour de l\'alerte:', alert);

                await updateAlert(alert);
                console.log('Alerte mise √† jour en base');

                // Recharger SEULEMENT les alertes, sans r√©g√©n√©ration
                await loadAlerts();
                showMessage('success', 'Alerte r√©solue avec succ√®s');

            } catch (error) {
                console.error('Erreur lors de la r√©solution:', error);
                showMessage('error', 'Erreur lors de la r√©solution : ' + error.message);
            }
        }

        // R√©activer une alerte
        async function unresolveAlert(alertId) {
            if (!confirm('√ätes-vous s√ªr de vouloir r√©activer cette alerte ?')) {
                return;
            }

            try {
                const alerts = await getAllAlerts();
                const alert = alerts.find(a => a.id === alertId);
                
                if (!alert) {
                    throw new Error('Alerte introuvable');
                }

                alert.status = 'active';
                alert.resolvedDate = null;
                alert.resolvedBy = null;
                alert.dateUpdated = new Date().toISOString();

                await updateAlert(alert);
                await loadAlerts();
                showMessage('success', 'Alerte r√©activ√©e avec succ√®s');

            } catch (error) {
                showMessage('error', 'Erreur lors de la r√©activation : ' + error.message);
            }
        }

        // Ajouter une note √† une alerte
        async function addAlertNote(alertId) {
            try {
                const alerts = await getAllAlerts();
                const alert = alerts.find(a => a.id === alertId);
                
                if (!alert) {
                    throw new Error('Alerte introuvable');
                }

                const currentNote = alert.notes || '';
                const newNote = prompt('Note sur cette alerte :', currentNote);
                
                if (newNote !== null) {
                    alert.notes = newNote;
                    alert.dateUpdated = new Date().toISOString();
                    
                    await updateAlert(alert);
                    await loadAlerts();
                    showMessage('success', 'Note mise √† jour');
                }

            } catch (error) {
                showMessage('error', 'Erreur lors de la mise √† jour : ' + error.message);
            }
        }

        // Voir les d√©tails du contr√¥le
        function viewControlDetails(controlId) {
            showTab('historique');
            // Faire d√©filer vers l'√©l√©ment apr√®s un court d√©lai
            setTimeout(() => {
                const controlElement = document.querySelector(`[onclick*="deleteControlById(${controlId})"]`);
                if (controlElement) {
                    const controlItem = controlElement.closest('.control-item');
                    if (controlItem) {
                        controlItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        controlItem.style.border = '3px solid #007bff';
                        controlItem.style.backgroundColor = '#f0f8ff';
                        
                        setTimeout(() => {
                            controlItem.style.border = '';
                            controlItem.style.backgroundColor = '';
                        }, 3000);
                    }
                }
            }, 500);
        }

        // Filtrer les alertes
        function filterAlerts() {
            const statusFilter = document.getElementById('alertStatusFilter').value;
            const typeFilter = document.getElementById('alertTypeFilter').value;
            const searchTerm = document.getElementById('alertSearchInput').value.toLowerCase();

            let filteredAlerts = [...currentAlerts];

            // Filtrer par statut
            if (statusFilter !== 'all') {
                filteredAlerts = filteredAlerts.filter(alert => alert.status === statusFilter);
            }

            // Filtrer par type
            if (typeFilter !== 'all') {
                filteredAlerts = filteredAlerts.filter(alert => alert.type === typeFilter);
            }

            // Filtrer par recherche textuelle
            if (searchTerm) {
                filteredAlerts = filteredAlerts.filter(alert => 
                    alert.immatriculation.toLowerCase().includes(searchTerm) ||
                    alert.conducteur.toLowerCase().includes(searchTerm)
                );
            }

            displayAlerts(filteredAlerts);
        }

        // Actualiser les alertes
        async function refreshAlerts() {
            try {
                showMessage('info', 'Actualisation des alertes en cours...');
                await loadAlerts();
                showMessage('success', 'Alertes actualis√©es avec succ√®s');
            } catch (error) {
                showMessage('error', 'Erreur lors de l\'actualisation : ' + error.message);
            }
        }

        // === NOUVELLES FONCTIONS EXPORT/IMPORT INDIVIDUELS ===

        // Exporter un contr√¥le individuel
        async function exportIndividualControl(controlId) {
            try {
                const controls = await getAllControls();
                const control = controls.find(c => c.id === controlId);
                
                if (!control) {
                    throw new Error('Contr√¥le introuvable');
                }

                // Cr√©er l'objet d'export avec m√©tadonn√©es
                const exportData = {
                    version: '4.0',
                    exportType: 'individual_control',
                    timestamp: new Date().toISOString(),
                    control: control,
                    metadata: {
                        exportedBy: 'GazService v4.0',
                        controlId: control.id,
                        immatriculation: control.immatriculation,
                        conducteur: control.conducteur,
                        dateControle: control.dateControle,
                        photosCount: control.photos ? control.photos.length : 0
                    }
                };

                // G√©n√©rer le nom de fichier
                const fileName = `Controle_${control.immatriculation}_${control.conducteur.replace(/\s+/g, '_')}_${control.dateControle}.json`;
                
                // T√©l√©charger
                downloadJSON(exportData, fileName);
                
                showMessage('success', `Contr√¥le export√© : ${fileName}`);
                
            } catch (error) {
                console.error('Erreur export individuel:', error);
                showMessage('error', 'Erreur lors de l\'export : ' + error.message);
            }
        }

        // G√©rer le fichier s√©lectionn√© pour import individuel
        function handleIndividualControlFile(input) {
            const importBtn = document.getElementById('importIndividualBtn');
            const statusEl = document.getElementById('importIndividualStatus');
            const previewEl = document.getElementById('importPreview');
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                
                if (!file.name.endsWith('.json')) {
                    statusEl.innerHTML = '<div class="error-message">Veuillez s√©lectionner un fichier JSON valide</div>';
                    importBtn.disabled = true;
                    previewEl.style.display = 'none';
                    return;
                }
                
                selectedIndividualFile = file;
                
                // Lire et pr√©visualiser le fichier
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importData = JSON.parse(e.target.result);
                        
                        if (importData.exportType !== 'individual_control' || !importData.control) {
                            throw new Error('Format de fichier invalide - Ce n\'est pas un export de contr√¥le individuel');
                        }
                        
                        displayImportPreview(importData.control);
                        importBtn.disabled = false;
                        statusEl.innerHTML = `<div class="info-message">Fichier s√©lectionn√© : ${file.name}</div>`;
                        
                    } catch (error) {
                        console.error('Erreur lecture fichier:', error);
                        statusEl.innerHTML = `<div class="error-message">Erreur de lecture : ${error.message}</div>`;
                        importBtn.disabled = true;
                        previewEl.style.display = 'none';
                    }
                };
                reader.readAsText(file);
            } else {
                selectedIndividualFile = null;
                importBtn.disabled = true;
                statusEl.innerHTML = '';
                previewEl.style.display = 'none';
            }
        }

        // Afficher l'aper√ßu du contr√¥le √† importer
        function displayImportPreview(control) {
            const previewEl = document.getElementById('importPreview');
            const contentEl = document.getElementById('importPreviewContent');
            
            const formatDate = (dateStr) => {
                if (!dateStr) return 'Non renseign√©';
                return new Date(dateStr).toLocaleDateString('fr-FR');
            };

            const formatBoolean = (value) => value ? '‚úì Pr√©sent' : '‚úó Absent';
            const formatState = (value) => {
                if (!value) return 'Non renseign√©';
                return value.charAt(0).toUpperCase() + value.slice(1);
            };

            contentEl.innerHTML = `
                <div class="import-preview-grid">
                    <div class="import-preview-item">
                        <div class="import-preview-label">Immatriculation</div>
                        <div class="import-preview-value"><strong>${control.immatriculation}</strong></div>
                    </div>
                    <div class="import-preview-item">
                        <div class="import-preview-label">Conducteur</div>
                        <div class="import-preview-value"><strong>${control.conducteur}</strong></div>
                    </div>
                    <div class="import-preview-item">
                        <div class="import-preview-label">Date contr√¥le</div>
                        <div class="import-preview-value">${formatDate(control.dateControle)}</div>
                    </div>
                    <div class="import-preview-item">
                        <div class="import-preview-label">Kilom√©trage</div>
                        <div class="import-preview-value">${control.kilometrage || 'Non renseign√©'} km</div>
                    </div>
                </div>

                <h5>üìã Documents</h5>
                <div class="import-preview-grid">
                    <div class="import-preview-item">
                        <div class="import-preview-label">Permis</div>
                        <div class="import-preview-value">${formatBoolean(control.permis)}</div>
                    </div>
                    <div class="import-preview-item">
                        <div class="import-preview-label">Carte verte</div>
                        <div class="import-preview-value">${formatBoolean(control.carteVerte)}</div>
                    </div>
                    <div class="import-preview-item">
                        <div class="import-preview-label">Carte grise</div>
                        <div class="import-preview-value">${formatBoolean(control.carteGrise)}</div>
                    </div>
                    <div class="import-preview-item">
                        <div class="import-preview-label">Carte carburant</div>
                        <div class="import-preview-value">${formatBoolean(control.carteCarburant)}</div>
                    </div>
                </div>

                <h5>üõ°Ô∏è √âquipements</h5>
                <div class="import-preview-grid">
                    <div class="import-preview-item">
                        <div class="import-preview-label">Gilet jaune</div>
                        <div class="import-preview-value">${formatBoolean(control.giletJaune)}</div>
                    </div>
                    <div class="import-preview-item">
                        <div class="import-preview-label">Triangle</div>
                        <div class="import-preview-value">${formatBoolean(control.triangle)}</div>
                    </div>
                    <div class="import-preview-item">
                        <div class="import-preview-label">Roue secours</div>
                        <div class="import-preview-value">${formatBoolean(control.roueSecours)}</div>
                    </div>
                    <div class="import-preview-item">
                        <div class="import-preview-label">Trousse secours</div>
                        <div class="import-preview-value">${formatBoolean(control.trousseSecours)}</div>
                    </div>
                </div>

                <h5>üîß √âtats</h5>
                <div class="import-preview-grid">
                    <div class="import-preview-item">
                        <div class="import-preview-label">Rangement</div>
                        <div class="import-preview-value">${formatState(control.etatRangement)}</div>
                    </div>
                    <div class="import-preview-item">
                        <div class="import-preview-label">Propret√© int.</div>
                        <div class="import-preview-value">${formatState(control.propreteInterieur)}</div>
                    </div>
                    <div class="import-preview-item">
                        <div class="import-preview-label">Propret√© ext.</div>
                        <div class="import-preview-value">${formatState(control.propreteExterieur)}</div>
                    </div>
                </div>

                <h5>üõû Pneus</h5>
                <div class="import-preview-grid">
                    <div class="import-preview-item">
                        <div class="import-preview-label">AV Gauche</div>
                        <div class="import-preview-value">${formatState(control.pneuAvantGauche)}</div>
                    </div>
                    <div class="import-preview-item">
                        <div class="import-preview-label">AV Droit</div>
                        <div class="import-preview-value">${formatState(control.pneuAvantDroit)}</div>
                    </div>
                    <div class="import-preview-item">
                        <div class="import-preview-label">AR Gauche</div>
                        <div class="import-preview-value">${formatState(control.pneuArriereGauche)}</div>
                    </div>
                    <div class="import-preview-item">
                        <div class="import-preview-label">AR Droit</div>
                        <div class="import-preview-value">${formatState(control.pneuArriereDroit)}</div>
                    </div>
                </div>

                ${control.photos && control.photos.length > 0 ? `
                    <h5>üì∏ Photos (${control.photos.length})</h5>
                    <div class="photos-grid" style="margin-top: 10px;">
                        ${control.photos.map((photo, index) => `
                            <img src="${photo.data}" 
                                 alt="Photo ${index + 1}" 
                                 class="photo-thumbnail" 
                                 onclick="viewPhoto('${photo.data}')"
                                 title="Cliquez pour agrandir">
                        `).join('')}
                    </div>
                ` : ''}

                ${control.commentaires ? `
                    <h5>üí¨ Commentaires</h5>
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; border-left: 4px solid #007bff; margin-top: 10px; white-space: pre-wrap;">${control.commentaires}</div>
                ` : ''}
            `;

            previewEl.style.display = 'block';
        }

        // Importer le contr√¥le individuel
        async function importIndividualControl() {
            if (!selectedIndividualFile) return;
            
            const statusEl = document.getElementById('importIndividualStatus');
            
            try {
                statusEl.innerHTML = '<div class="info-message">Import du contr√¥le en cours...</div>';
                
                const fileContent = await readFileAsText(selectedIndividualFile);
                const importData = JSON.parse(fileContent);
                
                if (!importData.control) {
                    throw new Error('Donn√©es de contr√¥le manquantes dans le fichier');
                }
                
                // Pr√©parer les donn√©es du contr√¥le (enlever l'ancien ID pour en g√©n√©rer un nouveau)
                const controlData = { ...importData.control };
                delete controlData.id; // Supprimer l'ID existant pour en g√©n√©rer un nouveau
                controlData.dateCreation = new Date().toISOString(); // Nouvelle date de cr√©ation
                controlData.importedFrom = selectedIndividualFile.name; // Tra√ßabilit√©
                
                // Sauvegarder le contr√¥le
                const newId = await saveControl(controlData);
                
                statusEl.innerHTML = `
                    <div class="success-message">
                        ‚úÖ Contr√¥le import√© avec succ√®s !<br>
                        <strong>V√©hicule :</strong> ${controlData.immatriculation} - ${controlData.conducteur}<br>
                        <strong>Date :</strong> ${new Date(controlData.dateControle).toLocaleDateString('fr-FR')}<br>
                        <strong>Photos :</strong> ${controlData.photos ? controlData.photos.length : 0}<br>
                        <strong>Nouveau ID :</strong> ${newId}
                    </div>
                `;
                
                // Nettoyer l'interface
                clearImportPreview();
                
                // Recharger l'historique si on est dessus
                if (document.getElementById('historique').classList.contains('active')) {
                    await loadControls();
                }
                
                showMessage('success', `Contr√¥le ${controlData.immatriculation} import√© avec succ√®s !`);
                
            } catch (error) {
                console.error('Erreur import individuel:', error);
                statusEl.innerHTML = `<div class="error-message">Erreur lors de l'import : ${error.message}</div>`;
            }
        }

        // Vider l'aper√ßu d'import
        function clearImportPreview() {
            selectedIndividualFile = null;
            document.getElementById('individualControlFile').value = '';
            document.getElementById('importIndividualBtn').disabled = true;
            document.getElementById('importPreview').style.display = 'none';
            document.getElementById('importIndividualStatus').innerHTML = '';
        }

        // === FONCTIONS DE BASE ===

        // Sauvegarder un contr√¥le
        function saveControl(data) {
            return new Promise(async (resolve, reject) => {
                try {
                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.add(data);
                    
                    request.onsuccess = async () => {
                        const controlId = request.result;
                        resolve(controlId);
                        
                        // G√©n√©rer automatiquement les alertes apr√®s sauvegarde
                        try {
                            await generateAlertsFromControl(controlId, data);
                        } catch (error) {
                            console.error('Erreur lors de la g√©n√©ration des alertes:', error);
                        }
                    };
                    request.onerror = () => reject(request.error);
                } catch (error) {
                    reject(error);
                }
            });
        }

        // R√©cup√©rer tous les contr√¥les
        function getAllControls() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // Supprimer un contr√¥le
        function deleteControl(id) {
            return new Promise(async (resolve, reject) => {
                try {
                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.delete(id);
                    
                    request.onsuccess = async () => {
                        // Supprimer les alertes associ√©es
                        try {
                            await deleteAlertsByControlId(id);
                        } catch (error) {
                            console.error('Erreur lors de la suppression des alertes:', error);
                        }
                        
                        resolve();
                    };
                    request.onerror = () => reject(request.error);
                } catch (error) {
                    reject(error);
                }
            });
        }

        function clearAllData() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.clear();
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // === FONCTIONS DE GESTION DES PHOTOS ===

        async function openCamera() {
            if (currentPhotos.length >= MAX_PHOTOS) {
                showMessage('warning', `Vous avez d√©j√† atteint la limite de ${MAX_PHOTOS} photos par contr√¥le`);
                return;
            }

            try {
                const modal = document.getElementById('cameraModal');
                const video = document.getElementById('cameraVideo');
                
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'environment'
                    } 
                });
                
                video.srcObject = cameraStream;
                modal.style.display = 'flex';
                
            } catch (error) {
                console.error('Erreur d\'acc√®s √† la cam√©ra:', error);
                showMessage('error', 'Impossible d\'acc√©der √† la cam√©ra. V√©rifiez les permissions de votre navigateur.');
            }
        }

        function closeCamera() {
            const modal = document.getElementById('cameraModal');
            const video = document.getElementById('cameraVideo');
            
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            video.srcObject = null;
            modal.style.display = 'none';
        }

        function takePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('photoCanvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            ctx.drawImage(video, 0, 0);
            
            const imageData = canvas.toDataURL('image/jpeg', 0.8);
            
            const photoObj = {
                id: Date.now() + Math.random(),
                data: imageData,
                timestamp: new Date().toISOString()
            };
            
            currentPhotos.push(photoObj);
            updatePhotoPreview();
            closeCamera();
            
            showMessage('success', `Photo ${currentPhotos.length}/${MAX_PHOTOS} ajout√©e avec succ√®s`);
        }

        function updatePhotoPreview() {
            const preview = document.getElementById('photoPreview');
            const counter = document.getElementById('photoCount');
            const cameraBtn = document.getElementById('cameraBtn');
            
            counter.textContent = `${currentPhotos.length}/${MAX_PHOTOS} photos`;
            
            if (currentPhotos.length >= MAX_PHOTOS) {
                cameraBtn.disabled = true;
                cameraBtn.textContent = 'üì± Limite atteinte (5/5)';
                cameraBtn.style.opacity = '0.6';
            } else {
                cameraBtn.disabled = false;
                cameraBtn.textContent = 'üì± Prendre une photo';
                cameraBtn.style.opacity = '1';
            }
            
            preview.innerHTML = currentPhotos.map((photo, index) => `
                <div class="photo-item">
                    <img src="${photo.data}" alt="Photo ${index + 1}" onclick="viewPhoto('${photo.data}')">
                    <button class="photo-delete" onclick="deletePhoto('${photo.id}')" title="Supprimer cette photo">√ó</button>
                </div>
            `).join('');
        }

        function deletePhoto(photoId) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cette photo ?')) {
                currentPhotos = currentPhotos.filter(photo => photo.id !== photoId);
                updatePhotoPreview();
                showMessage('success', 'Photo supprim√©e');
            }
        }

        function viewPhoto(imageData) {
            const modal = document.createElement('div');
            modal.className = 'photo-viewer-modal';
            modal.innerHTML = `
                <div class="photo-viewer-content">
                    <button class="photo-viewer-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
                    <img src="${imageData}" alt="Photo agrandie" class="photo-viewer-image">
                </div>
            `;
            
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            document.body.appendChild(modal);
        }

        function resetPhotos() {
            currentPhotos = [];
            updatePhotoPreview();
        }

        // === FONCTIONS PRINCIPALES ===

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Utiliser setTimeout pour √©viter les probl√®mes avec await dans les event handlers
            setTimeout(async () => {
                try {
                    if (tabName === 'historique') {
                        await loadControls();
                    } else if (tabName === 'alertes') {
                        await loadAlerts();
                    } else if (tabName === 'avancement') {
                        await loadVehicleProgress();
                    } else if (tabName === 'import-individuel') {
                        clearImportPreview();
                    } else if (tabName === 'pdf') {
                        const today = new Date().toISOString().split('T')[0];
                        const lastMonth = new Date();
                        lastMonth.setMonth(lastMonth.getMonth() - 1);
                        const lastMonthStr = lastMonth.toISOString().split('T')[0];
                        
                        if (!document.getElementById('pdfDateDebut').value) {
                            document.getElementById('pdfDateDebut').value = lastMonthStr;
                        }
                        if (!document.getElementById('pdfDateFin').value) {
                            document.getElementById('pdfDateFin').value = today;
                        }
                    }
                } catch (error) {
                    console.error('Erreur lors du changement d\'onglet:', error);
                }
            }, 0);
        }

        function resetForm() {
            document.getElementById('vehicleForm').reset();
            document.getElementById('dateControle').value = new Date().toISOString().split('T')[0];
            
            // R√©initialiser les styles des champs sp√©ciaux
            const conducteurField = document.getElementById('conducteur');
            const immatriculationField = document.getElementById('immatriculation');
            
            if (conducteurField) {
                conducteurField.style.borderColor = '#bdc3c7';
                conducteurField.style.backgroundColor = '#ffffff';
                conducteurField.title = 'Nom du conducteur (converti automatiquement en majuscules)';
            }
            
            if (immatriculationField) {
                immatriculationField.style.borderColor = '#bdc3c7';
                immatriculationField.style.backgroundColor = '#ffffff';
                immatriculationField.title = 'Format attendu: XX-123-XX';
            }
            
            updateCheckboxStyles();
            resetPhotos();
        }

        async function loadControls() {
            try {
                const controls = await getAllControls();
                displayControls(controls);
            } catch (error) {
                console.error('Erreur lors du chargement des contr√¥les:', error);
            }
        }

        function displayControls(controls) {
            const container = document.getElementById('controlsList');
            
            if (controls.length === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        <h3>Aucun contr√¥le enregistr√©</h3>
                        <p>Commencez par ajouter un nouveau contr√¥le</p>
                    </div>
                `;
                return;
            }
            
            controls.sort((a, b) => new Date(b.dateControle) - new Date(a.dateControle));
            
            container.innerHTML = controls.map(control => createControlCard(control)).join('');
        }

        function createControlCard(control) {
            const formatDate = (dateStr) => {
                if (!dateStr) return 'Non renseign√©';
                return new Date(dateStr).toLocaleDateString('fr-FR');
            };
            
            const formatKilometrage = (km) => {
                if (!km) return 'Non renseign√©';
                return km + ' km';
            };
            
            const getStatusBadge = (value, type = 'boolean') => {
                if (type === 'boolean') {
                    return value ? 
                        '<span class="status-badge status-ok">‚úì Pr√©sent</span>' :
                        '<span class="status-badge status-missing">‚úó Absent</span>';
                } else {
                    const safeValue = value || 'non-renseign√©';
                    return `<span class="status-badge status-${safeValue}">${safeValue.charAt(0).toUpperCase() + safeValue.slice(1)}</span>`;
                }
            };

            const commentairesSection = control.commentaires && control.commentaires.trim() ? `
                <div class="control-comments">
                    <h5>üí¨ Commentaires</h5>
                    <div class="comment-text" style="background: #f8f9fa; padding: 12px; border-radius: 6px; border-left: 4px solid #007bff; margin-top: 10px; white-space: pre-wrap;">${control.commentaires}</div>
                </div>
            ` : '';

            const photosSection = control.photos && control.photos.length > 0 ? `
                <div class="control-photos">
                    <h5>üì∏ Photos du contr√¥le (${control.photos.length})</h5>
                    <div class="photos-grid">
                        ${control.photos.map((photo, index) => `
                            <img src="${photo.data}" 
                                 alt="Photo ${index + 1}" 
                                 class="photo-thumbnail" 
                                 onclick="viewPhoto('${photo.data}')"
                                 title="Cliquez pour agrandir">
                        `).join('')}
                    </div>
                </div>
            ` : '';
            
            return `
                <div class="control-item">
                    <div class="control-header">
                        <h4>üöó ${control.immatriculation} - ${control.conducteur}</h4>
                        <div class="control-actions">
                            <button class="btn btn-info" onclick="exportIndividualControl(${control.id})" style="padding: 8px 15px; font-size: 0.9rem;">
                                üì§ Exporter
                            </button>
                            <button class="btn btn-danger" onclick="deleteControlById(${control.id})" style="padding: 8px 15px; font-size: 0.9rem;">
                                üóëÔ∏è Supprimer
                            </button>
                        </div>
                    </div>
                    
                    <div class="control-info">
                        <div class="info-item">
                            <span class="info-label">Date du contr√¥le</span>
                            <span class="info-value">${formatDate(control.dateControle)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Kilom√©trage</span>
                            <span class="info-value">${formatKilometrage(control.kilometrage)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Prochain CT</span>
                            <span class="info-value">${formatDate(control.prochainControle)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Derni√®re r√©vision</span>
                            <span class="info-value">${formatKilometrage(control.derniereRevision)}</span>
                        </div>
                    </div>
                    
                    <h5 style="margin: 15px 0 10px 0;">üìã Documents</h5>
                    <div class="control-info">
                        <div class="info-item">
                            <span class="info-label">Permis</span>
                            ${getStatusBadge(control.permis)}
                        </div>
                        <div class="info-item">
                            <span class="info-label">Carte verte</span>
                            ${getStatusBadge(control.carteVerte)}
                        </div>
                        <div class="info-item">
                            <span class="info-label">Carte grise</span>
                            ${getStatusBadge(control.carteGrise)}
                        </div>
                        <div class="info-item">
                            <span class="info-label">Carte carburant</span>
                            ${getStatusBadge(control.carteCarburant)}
                        </div>
                    </div>
                    
                    <h5 style="margin: 15px 0 10px 0;">üõ°Ô∏è √âquipements</h5>
                    <div class="control-info">
                        <div class="info-item">
                            <span class="info-label">Gilet jaune</span>
                            ${getStatusBadge(control.giletJaune)}
                        </div>
                        <div class="info-item">
                            <span class="info-label">Triangle</span>
                            ${getStatusBadge(control.triangle)}
                        </div>
                        <div class="info-item">
                            <span class="info-label">Roue secours</span>
                            ${getStatusBadge(control.roueSecours)}
                        </div>
                        <div class="info-item">
                            <span class="info-label">Trousse secours</span>
                            ${getStatusBadge(control.trousseSecours)}
                        </div>
                    </div>
                    
                    <h5 style="margin: 15px 0 10px 0;">üîß √âtat g√©n√©ral</h5>
                    <div class="control-info">
                        <div class="info-item">
                            <span class="info-label">Rangement</span>
                            ${getStatusBadge(control.etatRangement, 'state')}
                        </div>
                        <div class="info-item">
                            <span class="info-label">Propret√© int.</span>
                            ${getStatusBadge(control.propreteInterieur, 'state')}
                        </div>
                        <div class="info-item">
                            <span class="info-label">Propret√© ext.</span>
                            ${getStatusBadge(control.propreteExterieur, 'state')}
                        </div>
                    </div>
                    
                    <h5 style="margin: 15px 0 10px 0;">üõû Pneus</h5>
                    <div class="control-info">
                        <div class="info-item">
                            <span class="info-label">Avant gauche</span>
                            ${getStatusBadge(control.pneuAvantGauche, 'state')}
                        </div>
                        <div class="info-item">
                            <span class="info-label">Avant droit</span>
                            ${getStatusBadge(control.pneuAvantDroit, 'state')}
                        </div>
                        <div class="info-item">
                            <span class="info-label">Arri√®re gauche</span>
                            ${getStatusBadge(control.pneuArriereGauche, 'state')}
                        </div>
                        <div class="info-item">
                            <span class="info-label">Arri√®re droit</span>
                            ${getStatusBadge(control.pneuArriereDroit, 'state')}
                        </div>
                    </div>
                    
                    ${commentairesSection}
                    
                    ${photosSection}
                </div>
            `;
        }

        async function deleteControlById(id) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer ce contr√¥le ?')) {
                try {
                    await deleteControl(id);
                    showMessage('success', '‚úÖ Contr√¥le supprim√© avec succ√®s !');
                    await loadControls();
                    // Recharger les alertes si on est sur l'onglet alertes
                    if (document.getElementById('alertes').classList.contains('active')) {
                        await loadAlerts();
                    }
                } catch (error) {
                    showMessage('error', '‚ùå Erreur lors de la suppression : ' + error.message);
                }
            }
        }

        function filterControls() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const controlItems = document.querySelectorAll('.control-item');
            
            controlItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        }

        // === FONCTIONS DE SAUVEGARDE ===

        async function createManualBackup() {
            const statusEl = document.getElementById('manualBackupStatus');
            
            try {
                statusEl.innerHTML = '<div class="info-message">Cr√©ation de la sauvegarde en cours...</div>';
                
                const controls = await getAllControls();
                const alerts = await getAllAlerts();
                const vehicles = await getVehicleList(); // R√©cup√©rer la liste des v√©hicules du suivi d'avancement
                
                const backupData = {
                    version: '4.0',
                    timestamp: new Date().toISOString(),
                    type: 'manual',
                    data: {
                        controls: controls,
                        alerts: alerts,
                        vehicles: vehicles // Inclure la liste des v√©hicules
                    }
                };
                
                const filename = `GazService_Backup_${new Date().toISOString().replace(/[:.]/g, '-').split('T')[0]}.json`;
                
                downloadJSON(backupData, filename);
                statusEl.innerHTML = `<div class="success-message">Sauvegarde cr√©√©e et t√©l√©charg√©e : ${filename}<br>${controls.length} contr√¥le(s), ${alerts.length} alerte(s) et ${vehicles.length} v√©hicule(s) sauvegard√©(s)</div>`;
                
            } catch (error) {
                statusEl.innerHTML = '<div class="error-message">Erreur lors de la cr√©ation de la sauvegarde : ' + error.message + '</div>';
            }
        }

        function handleBackupFile(input) {
            const restoreBtn = document.getElementById('restoreBtn');
            const statusEl = document.getElementById('restoreStatus');
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                
                if (file.type !== 'application/json' && !file.name.endsWith('.json')) {
                    statusEl.innerHTML = '<div class="error-message">Veuillez s√©lectionner un fichier JSON valide</div>';
                    restoreBtn.disabled = true;
                    return;
                }
                
                selectedBackupFile = file;
                restoreBtn.disabled = false;
                statusEl.innerHTML = `<div class="info-message">Fichier s√©lectionn√© : ${file.name}</div>`;
            } else {
                selectedBackupFile = null;
                restoreBtn.disabled = true;
                statusEl.innerHTML = '';
            }
        }

        async function restoreBackup() {
            if (!selectedBackupFile) return;
            
            const statusEl = document.getElementById('restoreStatus');
            
            if (!confirm('‚ö†Ô∏è ATTENTION ‚ö†Ô∏è\n\nCette action va SUPPRIMER toutes les donn√©es actuelles et les remplacer par celles du fichier de sauvegarde.\n\n√ätes-vous s√ªr de vouloir continuer ?')) {
                return;
            }
            
            try {
                statusEl.innerHTML = '<div class="info-message">Restauration en cours...</div>';
                
                const fileContent = await readFileAsText(selectedBackupFile);
                const backupData = JSON.parse(fileContent);
                
                if (!backupData.data || !backupData.data.controls) {
                    throw new Error('Format de sauvegarde invalide');
                }
                
                const controls = backupData.data.controls;
                const alerts = backupData.data.alerts || []; // R√©cup√©rer les alertes sauvegard√©es
                const vehicles = backupData.data.vehicles || []; // R√©cup√©rer la liste des v√©hicules du suivi d'avancement
                
                // Vider la base actuelle
                await clearAllData();
                await clearAllAlerts();
                await clearVehicleListFromDB(); // Vider la liste des v√©hicules existante
                
                // Restaurer les contr√¥les SANS g√©n√©rer automatiquement les alertes
                let successCount = 0;
                for (const control of controls) {
                    try {
                        const { id, ...controlData } = control;
                        // Utiliser une transaction directe pour √©viter la g√©n√©ration automatique d'alertes
                        await saveControlWithoutAlerts(controlData);
                        successCount++;
                    } catch (error) {
                        console.error('Erreur import contr√¥le:', error);
                    }
                }
                
                // Restaurer les alertes sauvegard√©es
                let alertSuccessCount = 0;
                for (const alert of alerts) {
                    try {
                        const { id, ...alertData } = alert; // Supprimer l'ancien ID
                        await saveAlert(alertData);
                        alertSuccessCount++;
                    } catch (error) {
                        console.error('Erreur import alerte:', error);
                    }
                }
                
                // Restaurer la liste des v√©hicules du suivi d'avancement
                let vehicleSuccessCount = 0;
                if (vehicles.length > 0) {
                    try {
                        await saveVehicleList(vehicles);
                        vehicleSuccessCount = vehicles.length;
                    } catch (error) {
                        console.error('Erreur import v√©hicules:', error);
                    }
                }
                
                statusEl.innerHTML = `<div class="success-message">‚úÖ Restauration r√©ussie !<br>${successCount} contr√¥le(s), ${alertSuccessCount} alerte(s) et ${vehicleSuccessCount} v√©hicule(s) restaur√©(s)</div>`;
                
                // Nettoyer
                document.getElementById('backupFile').value = '';
                document.getElementById('restoreBtn').disabled = true;
                selectedBackupFile = null;
                
                // Recharger l'affichage
                if (document.getElementById('historique').classList.contains('active')) {
                    loadControls();
                }
                if (document.getElementById('alertes').classList.contains('active')) {
                    loadAlerts();
                }
                if (document.getElementById('avancement').classList.contains('active')) {
                    loadVehicleProgress(); // Recharger le suivi d'avancement
                }
                
            } catch (error) {
                statusEl.innerHTML = `<div class="error-message">Erreur lors de la restauration : ${error.message}</div>`;
            }
        }

        // Fonction pour sauvegarder un contr√¥le sans g√©n√©rer automatiquement les alertes
        function saveControlWithoutAlerts(data) {
            return new Promise((resolve, reject) => {
                try {
                    // S'assurer que toutes les propri√©t√©s essentielles sont pr√©sentes
                    const cleanedData = {
                        ...data,
                        // S'assurer que les propri√©t√©s d'√©tat sont pr√©serv√©es
                        etatRangement: data.etatRangement || 'bon',
                        propreteInterieur: data.propreteInterieur || 'bon',
                        propreteExterieur: data.propreteExterieur || 'bon',
                        // S'assurer que les pneus sont pr√©serv√©s
                        pneuAvantGauche: data.pneuAvantGauche || 'bon',
                        pneuAvantDroit: data.pneuAvantDroit || 'bon',
                        pneuArriereGauche: data.pneuArriereGauche || 'bon',
                        pneuArriereDroit: data.pneuArriereDroit || 'bon',
                        // S'assurer que les bool√©ens sont corrects
                        permis: Boolean(data.permis),
                        carteVerte: Boolean(data.carteVerte),
                        carteGrise: Boolean(data.carteGrise),
                        carteCarburant: Boolean(data.carteCarburant),
                        giletJaune: Boolean(data.giletJaune),
                        triangle: Boolean(data.triangle),
                        roueSecours: Boolean(data.roueSecours),
                        trousseSecours: Boolean(data.trousseSecours),
                        // Pr√©server les autres champs
                        dateCreation: data.dateCreation || new Date().toISOString(),
                        photos: data.photos || [],
                        commentaires: data.commentaires || ''
                    };

                    console.log('Donn√©es √† sauvegarder:', cleanedData);
                    
                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.add(cleanedData);
                    
                    request.onsuccess = () => {
                        const controlId = request.result;
                        console.log('Contr√¥le restaur√© avec ID:', controlId);
                        resolve(controlId);
                        // NE PAS g√©n√©rer automatiquement les alertes lors de la restauration
                    };
                    request.onerror = () => reject(request.error);
                } catch (error) {
                    reject(error);
                }
            });
        }

        function clearAllAlerts() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([ALERT_STORE_NAME], 'readwrite');
                const store = transaction.objectStore(ALERT_STORE_NAME);
                const request = store.clear();
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // === EXPORT EXCEL ===

        async function exportToExcel() {
            const loadingEl = document.getElementById('exportLoading');
            const statusEl = document.getElementById('exportStatus');
            
            try {
                loadingEl.style.display = 'block';
                statusEl.innerHTML = '';
                
                const controls = await getAllControls();
                
                if (controls.length === 0) {
                    throw new Error('Aucune donn√©e √† exporter');
                }
                
                const excelData = controls.map(control => ({
                    'Date contr√¥le': control.dateControle,
                    'Conducteur': control.conducteur,
                    'Immatriculation': control.immatriculation,
                    'Kilom√©trage': control.kilometrage || '',
                    'Prochain CT': control.prochainControle || '',
                    'Derni√®re r√©vision (km)': control.derniereRevision || '',
                    'Permis': control.permis ? 'Oui' : 'Non',
                    'Carte verte': control.carteVerte ? 'Oui' : 'Non',
                    'Carte grise': control.carteGrise ? 'Oui' : 'Non',
                    'Carte carburant': control.carteCarburant ? 'Oui' : 'Non',
                    'Gilet jaune': control.giletJaune ? 'Oui' : 'Non',
                    'Triangle': control.triangle ? 'Oui' : 'Non',
                    'Roue secours': control.roueSecours ? 'Oui' : 'Non',
                    'Trousse secours': control.trousseSecours ? 'Oui' : 'Non',
                    '√âtat rangement': control.etatRangement,
                    'Propret√© int√©rieur': control.propreteInterieur,
                    'Propret√© ext√©rieur': control.propreteExterieur,
                    'Pneu AV G': control.pneuAvantGauche,
                    'Pneu AV D': control.pneuAvantDroit,
                    'Pneu AR G': control.pneuArriereGauche,
                    'Pneu AR D': control.pneuArriereDroit,
                    'Commentaires': control.commentaires || '',
                    'Nb Photos': control.photos ? control.photos.length : 0,
                    'Date cr√©ation': new Date(control.dateCreation).toLocaleDateString('fr-FR')
                }));
                
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(excelData);
                
                XLSX.utils.book_append_sheet(wb, ws, 'Contr√¥les V√©hicules');
                
                const fileName = `Controles_Vehicules_GazService_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                statusEl.innerHTML = `<div class="success-message">‚úÖ Fichier "${fileName}" t√©l√©charg√© avec succ√®s !</div>`;
                
            } catch (error) {
                statusEl.innerHTML = `<div class="error-message">‚ùå Erreur lors de l'export : ${error.message}</div>`;
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        // === FONCTIONS DE SUIVI D'AVANCEMENT ===

        const CONTROL_EXPIRY_DAYS = 35;
        let vehicleList = [];
        let selectedVehicleFile = null;

        // Fonction utilitaire pour calculer la diff√©rence en jours
        function daysDifference(dateString) {
            if (!dateString) return Infinity;
            const controlDate = new Date(dateString);
            const today = new Date();
            const diffTime = today.getTime() - controlDate.getTime();
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        // Fonction pour v√©rifier si un contr√¥le est valide (moins de 35 jours)
        function isControlValid(controlDate) {
            return daysDifference(controlDate) <= CONTROL_EXPIRY_DAYS;
        }

        // Sauvegarder la liste des v√©hicules
        function saveVehicleList(vehicles) {
            return new Promise((resolve, reject) => {
                try {
                    const vehicleData = {
                        vehicles: vehicles,
                        timestamp: new Date().toISOString(),
                        version: '4.0'
                    };
                    localStorage.setItem('gazservice_vehicles', JSON.stringify(vehicleData));
                    resolve();
                } catch (error) {
                    reject(error);
                }
            });
        }

        // R√©cup√©rer la liste des v√©hicules
        function getVehicleList() {
            return new Promise((resolve) => {
                try {
                    const data = localStorage.getItem('gazservice_vehicles');
                    if (data) {
                        const parsed = JSON.parse(data);
                        resolve(parsed.vehicles || []);
                    } else {
                        resolve([]);
                    }
                } catch (error) {
                    resolve([]);
                }
            });
        }

        // Vider la liste des v√©hicules
        function clearVehicleListFromDB() {
            return new Promise((resolve) => {
                localStorage.removeItem('gazservice_vehicles');
                resolve();
            });
        }

        // G√©rer le fichier de liste de v√©hicules
        function handleVehicleListFile(input) {
            const importBtn = document.getElementById('importVehicleBtn');
            const statusEl = document.getElementById('progressStatus');
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                
                if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
                    statusEl.innerHTML = '<div class="error-message">Veuillez s√©lectionner un fichier Excel (.xlsx ou .xls)</div>';
                    importBtn.disabled = true;
                    return;
                }
                
                selectedVehicleFile = file;
                importBtn.disabled = false;
                statusEl.innerHTML = `<div class="info-message">Fichier s√©lectionn√© : ${file.name}</div>`;
            } else {
                selectedVehicleFile = null;
                importBtn.disabled = true;
                statusEl.innerHTML = '';
            }
        }

        // Importer la liste des v√©hicules
        async function importVehicleList() {
            if (!selectedVehicleFile) return;
            
            const statusEl = document.getElementById('progressStatus');
            
            try {
                statusEl.innerHTML = '<div class="info-message">Lecture du fichier Excel...</div>';
                
                const arrayBuffer = await readFileAsArrayBuffer(selectedVehicleFile);
                const workbook = XLSX.read(arrayBuffer);
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                if (jsonData.length < 2) {
                    throw new Error('Le fichier doit contenir au moins une ligne de donn√©es');
                }
                
                const vehicles = [];
                const startRow = 0;
                
                for (let i = startRow; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    
                    if (row[0] && row[0].toString().trim()) {
                        const immatriculation = row[0].toString().trim().toUpperCase();
                        const marque = row[1] ? row[1].toString().trim() : '';
                        const modele = row[2] ? row[2].toString().trim() : '';
                        
                        if (immatriculation.length > 0) {
                            vehicles.push({
                                immatriculation: immatriculation,
                                marque: marque,
                                modele: modele,
                                dateImport: new Date().toISOString()
                            });
                        }
                    }
                }
                
                if (vehicles.length === 0) {
                    throw new Error('Aucun v√©hicule valide trouv√© dans le fichier');
                }
                
                await saveVehicleList(vehicles);
                await loadVehicleProgress();
                
                statusEl.innerHTML = `<div class="success-message">‚úÖ ${vehicles.length} v√©hicule(s) import√©(s) avec succ√®s !</div>`;
                
                document.getElementById('vehicleListFile').value = '';
                document.getElementById('importVehicleBtn').disabled = true;
                selectedVehicleFile = null;
                
            } catch (error) {
                statusEl.innerHTML = `<div class="error-message">‚ùå Erreur lors de l'importation : ${error.message}</div>`;
            }
        }

        // Fonction utilitaire pour lire un fichier comme ArrayBuffer
        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = e => reject(new Error('Erreur de lecture du fichier'));
                reader.readAsArrayBuffer(file);
            });
        }

        // Charger et afficher le suivi d'avancement
        async function loadVehicleProgress() {
            try {
                const vehicles = await getVehicleList();
                const controls = await getAllControls();
                
                if (vehicles.length === 0) {
                    document.getElementById('progressStats').style.display = 'none';
                    document.getElementById('vehicleListContainer').style.display = 'none';
                    return;
                }
                
                const totalVehicles = vehicles.length;
                let controlledCount = 0;
                let expiredCount = 0;
                
                // Cr√©er un map des contr√¥les par immatriculation (prendre le plus r√©cent)
                const controlMap = new Map();
                controls.forEach(control => {
                    const immat = control.immatriculation;
                    if (!controlMap.has(immat) || new Date(control.dateControle) > new Date(controlMap.get(immat).dateControle)) {
                        controlMap.set(immat, control);
                    }
                });
                
                // V√©rifier chaque v√©hicule avec la r√®gle des 35 jours
                const vehicleProgress = vehicles.map(vehicle => {
                    const control = controlMap.get(vehicle.immatriculation);
                    
                    if (!control) {
                        return {
                            ...vehicle,
                            status: 'pending',
                            isControlled: false,
                            lastControl: null,
                            daysSinceControl: Infinity
                        };
                    }
                    
                    const daysSince = daysDifference(control.dateControle);
                    const isValid = isControlValid(control.dateControle);
                    
                    if (isValid) {
                        controlledCount++;
                        return {
                            ...vehicle,
                            status: 'controlled',
                            isControlled: true,
                            lastControl: control,
                            daysSinceControl: daysSince
                        };
                    } else {
                        expiredCount++;
                        return {
                            ...vehicle,
                            status: 'expired',
                            isControlled: false,
                            lastControl: control,
                            daysSinceControl: daysSince
                        };
                    }
                });
                
                const pendingCount = totalVehicles - controlledCount - expiredCount;
                const completionPercent = totalVehicles > 0 ? Math.round((controlledCount / totalVehicles) * 100) : 0;
                
                // Mettre √† jour les statistiques
                document.getElementById('totalVehicles').textContent = totalVehicles;
                document.getElementById('controlledVehicles').textContent = controlledCount;
                document.getElementById('expiredVehicles').textContent = expiredCount;
                document.getElementById('pendingVehicles').textContent = pendingCount;
                document.getElementById('completionPercent').textContent = completionPercent + '%';
                document.getElementById('progressFill').style.width = completionPercent + '%';
                
                document.getElementById('progressStats').style.display = 'grid';
                document.getElementById('vehicleListContainer').style.display = 'block';
                
                displayVehicleList(vehicleProgress);
                vehicleList = vehicleProgress;
                
            } catch (error) {
                console.error('Erreur lors du chargement du suivi d\'avancement:', error);
            }
        }

        // Afficher la liste des v√©hicules
        function displayVehicleList(vehicles) {
            const container = document.getElementById('vehicleList');
            
            if (vehicles.length === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        <h3>Aucun v√©hicule dans la liste</h3>
                        <p>Importez un fichier Excel pour commencer le suivi</p>
                    </div>
                `;
                return;
            }
            
            vehicles.sort((a, b) => {
                const statusOrder = { 'pending': 1, 'expired': 2, 'controlled': 3 };
                if (statusOrder[a.status] !== statusOrder[b.status]) {
                    return statusOrder[a.status] - statusOrder[b.status];
                }
                return a.immatriculation.localeCompare(b.immatriculation);
            });
            
            container.innerHTML = vehicles.map(vehicle => {
                let statusClass, statusIcon, statusText, lastControlText;
                
                switch (vehicle.status) {
                    case 'controlled':
                        statusClass = 'checked';
                        statusIcon = '‚úì';
                        statusText = `Contr√¥l√© (${vehicle.daysSinceControl}j)`;
                        lastControlText = new Date(vehicle.lastControl.dateControle).toLocaleDateString('fr-FR');
                        break;
                    case 'expired':
                        statusClass = 'expired';
                        statusIcon = '‚ö†';
                        statusText = `Expir√© (${vehicle.daysSinceControl}j)`;
                        lastControlText = new Date(vehicle.lastControl.dateControle).toLocaleDateString('fr-FR');
                        break;
                    default:
                        statusClass = 'pending';
                        statusIcon = '!';
                        statusText = 'En attente';
                        lastControlText = 'Aucun contr√¥le';
                }
                
                return `
                    <div class="vehicle-item ${statusClass}" style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s ease;">
                        <div class="vehicle-info" style="flex: 1;">
                            <div style="font-weight: bold; font-size: 1.1rem; color: #2c3e50;">${vehicle.immatriculation}</div>
                            <div style="color: #6c757d; font-size: 0.9rem; margin-top: 3px;">
                                ${vehicle.marque} ${vehicle.modele}
                                ${vehicle.lastControl ? ` - Conducteur: ${vehicle.lastControl.conducteur}` : ''}
                            </div>
                            <div style="font-size: 0.8rem; color: #6c757d;">Dernier contr√¥le: ${lastControlText}</div>
                        </div>
                        <div class="vehicle-status" style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; background: ${vehicle.status === 'controlled' ? '#28a745' : vehicle.status === 'expired' ? '#ff6b6b' : '#dc3545'};">${statusIcon}</div>
                            <span>${statusText}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Filtrer la liste des v√©hicules
        function filterVehicleList() {
            const searchTerm = document.getElementById('vehicleSearchInput').value.toLowerCase();
            const vehicleItems = document.querySelectorAll('.vehicle-item');
            
            vehicleItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? 'flex' : 'none';
            });
        }

        // Vider la liste des v√©hicules
        async function clearVehicleList() {
            if (confirm('√ätes-vous s√ªr de vouloir vider la liste des v√©hicules ?')) {
                try {
                    await clearVehicleListFromDB();
                    await loadVehicleProgress();
                    showMessage('success', '‚úÖ Liste des v√©hicules vid√©e avec succ√®s');
                } catch (error) {
                    showMessage('error', '‚ùå Erreur lors de la suppression : ' + error.message);
                }
            }
        }

        // Exporter le suivi d'avancement vers Excel
        async function exportProgressToExcel() {
            try {
                const vehicles = await getVehicleList();
                const controls = await getAllControls();
                
                if (vehicles.length === 0) {
                    showMessage('warning', 'Aucune donn√©e √† exporter');
                    return;
                }
                
                const controlMap = new Map();
                controls.forEach(control => {
                    const immat = control.immatriculation;
                    if (!controlMap.has(immat) || new Date(control.dateControle) > new Date(controlMap.get(immat).dateControle)) {
                        controlMap.set(immat, control);
                    }
                });
                
                const excelData = vehicles.map(vehicle => {
                    const control = controlMap.get(vehicle.immatriculation);
                    let status = 'En attente';
                    let daysSince = '';
                    
                    if (control) {
                        const days = daysDifference(control.dateControle);
                        daysSince = days;
                        status = isControlValid(control.dateControle) ? 
                            `Contr√¥l√© (${days}j)` : `Expir√© (${days}j)`;
                    }
                    
                    return {
                        'Immatriculation': vehicle.immatriculation,
                        'Marque': vehicle.marque,
                        'Mod√®le': vehicle.modele,
                        'Statut': status,
                        'Jours depuis contr√¥le': daysSince,
                        'Date dernier contr√¥le': control ? control.dateControle : '',
                        'Conducteur': control ? control.conducteur : '',
                        'Kilom√©trage': control ? control.kilometrage || '' : '',
                        'Prochain CT': control ? control.prochainControle || '' : '',
                        'Derni√®re r√©vision (km)': control ? control.derniereRevision || '' : '',
                        'Date import v√©hicule': new Date(vehicle.dateImport).toLocaleDateString('fr-FR')
                    };
                });
                
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(excelData);
                
                XLSX.utils.book_append_sheet(wb, ws, 'Suivi Avancement');
                
                const fileName = `Suivi_Avancement_GazService_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showMessage('success', `‚úÖ Fichier "${fileName}" t√©l√©charg√© avec succ√®s !`);
                
            } catch (error) {
                showMessage('error', '‚ùå Erreur lors de l\'export : ' + error.message);
            }
        }

        // === FONCTIONS PDF ===

        let filteredControlsForPDF = [];

        // Filtrer les contr√¥les pour PDF
        async function filterControlsForPDF() {
            const dateDebut = document.getElementById('pdfDateDebut').value;
            const dateFin = document.getElementById('pdfDateFin').value;
            const resultsDiv = document.getElementById('pdfResults');
            const listDiv = document.getElementById('pdfControlsList');
            const statusDiv = document.getElementById('pdfStatus');

            try {
                statusDiv.innerHTML = '<div class="info-message">Recherche des contr√¥les...</div>';
                
                const allControls = await getAllControls();
                
                let filtered = allControls;
                
                if (dateDebut) {
                    filtered = filtered.filter(control => control.dateControle >= dateDebut);
                }
                
                if (dateFin) {
                    filtered = filtered.filter(control => control.dateControle <= dateFin);
                }
                
                filtered.sort((a, b) => new Date(b.dateControle) - new Date(a.dateControle));
                
                filteredControlsForPDF = filtered;
                
                if (filtered.length === 0) {
                    statusDiv.innerHTML = '<div class="warning-message">Aucun contr√¥le trouv√© pour cette p√©riode</div>';
                    resultsDiv.style.display = 'none';
                    return;
                }
                
                listDiv.innerHTML = filtered.map(control => `
                    <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <strong>${control.immatriculation} - ${control.conducteur}</strong><br>
                            <small>Date: ${new Date(control.dateControle).toLocaleDateString('fr-FR')}</small>
                            ${control.photos && control.photos.length > 0 ? ` - ${control.photos.length} photo(s)` : ''}
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-info" onclick="generateSinglePDF(${control.id})" style="padding: 8px 15px; font-size: 0.9rem;">
                                üìÑ G√©n√©rer PDF
                            </button>
                        </div>
                    </div>
                `).join('');
                
                resultsDiv.style.display = 'block';
                statusDiv.innerHTML = `<div class="success-message">${filtered.length} contr√¥le(s) trouv√©(s)</div>`;
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="error-message">Erreur lors de la recherche: ${error.message}</div>`;
            }
        }

        // G√©n√©rer un PDF pour un contr√¥le
        async function generateSinglePDF(controlId) {
            const loadingEl = document.getElementById('pdfLoading');
            const statusEl = document.getElementById('pdfStatus');
            
            try {
                loadingEl.style.display = 'block';
                statusEl.innerHTML = '';
                
                // R√©cup√©rer le contr√¥le sp√©cifique
                const controls = await getAllControls();
                const control = controls.find(c => c.id === controlId);
                
                if (!control) {
                    throw new Error('Contr√¥le introuvable');
                }
                
                // Cr√©er un nouveau document PDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF();
                
                // Configuration des polices et couleurs
                const primaryColor = [44, 62, 80];  // #2c3e50
                const secondaryColor = [108, 117, 125]; // #6c757d
                const successColor = [39, 174, 96]; // #27ae60
                const dangerColor = [231, 76, 60]; // #e74c3c
                
                let yPos = 20;
                
                // En-t√™te du document
                pdf.setFillColor(...primaryColor);
                pdf.rect(0, 0, 210, 30, 'F');
                
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(18);
                pdf.setFont('helvetica', 'bold');
                pdf.text('RAPPORT DE CONTR√îLE V√âHICULE', 105, 15, { align: 'center' });
                
                pdf.setFontSize(12);
                pdf.setFont('helvetica', 'normal');
                pdf.text('Gaz Service - Syst√®me de suivi v4.0', 105, 22, { align: 'center' });
                
                yPos = 45;
                
                // Informations g√©n√©rales
                pdf.setTextColor(...primaryColor);
                pdf.setFontSize(14);
                pdf.setFont('helvetica', 'bold');
                pdf.text('INFORMATIONS G√âN√âRALES', 20, yPos);
                yPos += 10;
                
                pdf.setFontSize(10);
                pdf.setFont('helvetica', 'normal');
                pdf.setTextColor(0, 0, 0);
                
                const formatDate = (dateStr) => {
                    if (!dateStr) return 'Non renseign√©';
                    return new Date(dateStr).toLocaleDateString('fr-FR');
                };
                
                pdf.text(`Immatriculation: ${control.immatriculation}`, 20, yPos);
                pdf.text(`Date du contr√¥le: ${formatDate(control.dateControle)}`, 120, yPos);
                yPos += 7;
                
                pdf.text(`Conducteur: ${control.conducteur}`, 20, yPos);
                pdf.text(`Kilom√©trage: ${control.kilometrage || 'Non renseign√©'} km`, 120, yPos);
                yPos += 7;
                
                pdf.text(`Prochain CT: ${formatDate(control.prochainControle)}`, 20, yPos);
                pdf.text(`Derni√®re r√©vision: ${control.derniereRevision || 'Non renseign√©'} km`, 120, yPos);
                yPos += 15;
                
                // Documents obligatoires
                pdf.setTextColor(...primaryColor);
                pdf.setFontSize(12);
                pdf.setFont('helvetica', 'bold');
                pdf.text('DOCUMENTS OBLIGATOIRES', 20, yPos);
                yPos += 8;
                
                const documents = {
                    'Permis de conduire': control.permis,
                    'Carte verte (assurance)': control.carteVerte,
                    'Carte grise': control.carteGrise,
                    'Carte carburant': control.carteCarburant
                };
                
                pdf.setFontSize(10);
                pdf.setFont('helvetica', 'normal');
                
                Object.entries(documents).forEach(([label, value]) => {
                    pdf.setTextColor(0, 0, 0);
                    pdf.text(`${label}:`, 25, yPos);
                    
                    if (value) {
                        pdf.setTextColor(...successColor);
                        pdf.text('‚úì Pr√©sent', 80, yPos);
                    } else {
                        pdf.setTextColor(...dangerColor);
                        pdf.text('‚úó Absent', 80, yPos);
                    }
                    yPos += 6;
                });
                
                yPos += 8;
                
                // √âquipements de s√©curit√©
                pdf.setTextColor(...primaryColor);
                pdf.setFontSize(12);
                pdf.setFont('helvetica', 'bold');
                pdf.text('√âQUIPEMENTS DE S√âCURIT√â', 20, yPos);
                yPos += 8;
                
                const equipments = {
                    'Gilet jaune': control.giletJaune,
                    'Triangle de signalisation': control.triangle,
                    'Roue de secours': control.roueSecours,
                    'Trousse de secours': control.trousseSecours
                };
                
                pdf.setFontSize(10);
                pdf.setFont('helvetica', 'normal');
                
                Object.entries(equipments).forEach(([label, value]) => {
                    pdf.setTextColor(0, 0, 0);
                    pdf.text(`${label}:`, 25, yPos);
                    
                    if (value) {
                        pdf.setTextColor(...successColor);
                        pdf.text('‚úì Pr√©sent', 80, yPos);
                    } else {
                        pdf.setTextColor(...dangerColor);
                        pdf.text('‚úó Absent', 80, yPos);
                    }
                    yPos += 6;
                });
                
                yPos += 8;
                
                // √âtat g√©n√©ral
                pdf.setTextColor(...primaryColor);
                pdf.setFontSize(12);
                pdf.setFont('helvetica', 'bold');
                pdf.text('√âTAT G√âN√âRAL', 20, yPos);
                yPos += 8;
                
                const states = {
                    'Rangement du v√©hicule': control.etatRangement,
                    'Propret√© int√©rieur': control.propreteInterieur,
                    'Propret√© ext√©rieur': control.propreteExterieur
                };
                
                pdf.setFontSize(10);
                pdf.setFont('helvetica', 'normal');
                
                Object.entries(states).forEach(([label, value]) => {
                    pdf.setTextColor(0, 0, 0);
                    pdf.text(`${label}:`, 25, yPos);
                    
                    const stateText = (value || 'Non renseign√©').charAt(0).toUpperCase() + (value || 'Non renseign√©').slice(1);
                    
                    if (value === 'bon') {
                        pdf.setTextColor(...successColor);
                    } else if (value === 'moyen') {
                        pdf.setTextColor(243, 156, 18); // Orange
                    } else if (value === 'mauvais') {
                        pdf.setTextColor(...dangerColor);
                    } else {
                        pdf.setTextColor(...secondaryColor);
                    }
                    
                    pdf.text(stateText, 80, yPos);
                    yPos += 6;
                });
                
                yPos += 8;
                
                // √âtat des pneus
                pdf.setTextColor(...primaryColor);
                pdf.setFontSize(12);
                pdf.setFont('helvetica', 'bold');
                pdf.text('√âTAT DES PNEUS', 20, yPos);
                yPos += 8;
                
                const tires = {
                    'Pneu avant gauche': control.pneuAvantGauche,
                    'Pneu avant droit': control.pneuAvantDroit,
                    'Pneu arri√®re gauche': control.pneuArriereGauche,
                    'Pneu arri√®re droit': control.pneuArriereDroit
                };
                
                pdf.setFontSize(10);
                pdf.setFont('helvetica', 'normal');
                
                Object.entries(tires).forEach(([label, value]) => {
                    pdf.setTextColor(0, 0, 0);
                    pdf.text(`${label}:`, 25, yPos);
                    
                    const stateText = (value || 'Non renseign√©').charAt(0).toUpperCase() + (value || 'Non renseign√©').slice(1);
                    
                    if (value === 'bon') {
                        pdf.setTextColor(...successColor);
                    } else if (value === 'moyen') {
                        pdf.setTextColor(243, 156, 18); // Orange
                    } else if (value === 'mauvais') {
                        pdf.setTextColor(...dangerColor);
                    } else {
                        pdf.setTextColor(...secondaryColor);
                    }
                    
                    pdf.text(stateText, 80, yPos);
                    yPos += 6;
                });
                
                // Commentaires s'il y en a
                if (control.commentaires && control.commentaires.trim()) {
                    yPos += 8;
                    
                    // V√©rifier si on a assez de place, sinon ajouter une page
                    if (yPos > 250) {
                        pdf.addPage();
                        yPos = 20;
                    }
                    
                    pdf.setTextColor(...primaryColor);
                    pdf.setFontSize(12);
                    pdf.setFont('helvetica', 'bold');
                    pdf.text('COMMENTAIRES ET OBSERVATIONS', 20, yPos);
                    yPos += 8;
                    
                    pdf.setTextColor(0, 0, 0);
                    pdf.setFontSize(10);
                    pdf.setFont('helvetica', 'normal');
                    
                    // Diviser les commentaires en lignes
                    const commentLines = pdf.splitTextToSize(control.commentaires, 170);
                    pdf.text(commentLines, 20, yPos);
                    yPos += commentLines.length * 5;
                }
                
                // Informations sur les photos
                if (control.photos && control.photos.length > 0) {
                    yPos += 8;
                    
                    if (yPos > 270) {
                        pdf.addPage();
                        yPos = 20;
                    }
                    
                    pdf.setTextColor(...primaryColor);
                    pdf.setFontSize(12);
                    pdf.setFont('helvetica', 'bold');
                    pdf.text(`PHOTOS DU CONTR√îLE (${control.photos.length})`, 20, yPos);
                    yPos += 6;
                    
                    pdf.setTextColor(...secondaryColor);
                    pdf.setFontSize(9);
                    pdf.setFont('helvetica', 'normal');
                    pdf.text(`${control.photos.length} photo(s) ont √©t√© prises lors de ce contr√¥le.`, 20, yPos);
                    pdf.text('Les photos sont disponibles dans la version num√©rique du contr√¥le.', 20, yPos + 5);
                }
                
                // Pied de page
                const now = new Date().toLocaleString('fr-FR');
                pdf.setTextColor(...secondaryColor);
                pdf.setFontSize(8);
                pdf.text(`Rapport g√©n√©r√© le ${now} par Gaz Service v4.0`, 20, 285);
                pdf.text(`ID Contr√¥le: ${control.id}`, 150, 285);
                
                // T√©l√©charger le PDF
                const fileName = `Controle_${control.immatriculation}_${control.conducteur.replace(/\s+/g, '_')}_${control.dateControle}.pdf`;
                pdf.save(fileName);
                
                statusEl.innerHTML = `<div class="success-message">‚úÖ PDF g√©n√©r√© avec succ√®s : ${fileName}</div>`;
                
            } catch (error) {
                console.error('Erreur lors de la g√©n√©ration du PDF:', error);
                statusEl.innerHTML = `<div class="error-message">‚ùå Erreur lors de la g√©n√©ration du PDF : ${error.message}</div>`;
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        // === FONCTIONS DE MAINTENANCE ===

        // Diagnostiquer les doublons d'alertes
        async function diagnoseDuplicateAlerts() {
            const statusEl = document.getElementById('duplicateStatus');
            
            try {
                statusEl.innerHTML = '<div class="info-message">Analyse des doublons en cours...</div>';
                
                const alerts = await getAllAlerts();
                const duplicates = [];
                const seen = new Map();
                
                alerts.forEach(alert => {
                    const key = `${alert.immatriculation}_${alert.conducteur}_${alert.dateControle}`;
                    if (seen.has(key)) {
                        duplicates.push(alert);
                    } else {
                        seen.set(key, alert);
                    }
                });
                
                if (duplicates.length === 0) {
                    statusEl.innerHTML = '<div class="success-message">‚úÖ Aucun doublon d√©tect√© dans les alertes !</div>';
                } else {
                    statusEl.innerHTML = `<div class="warning-message">‚ö†Ô∏è ${duplicates.length} doublon(s) d√©tect√©(s) !</div>`;
                }
                
            } catch (error) {
                statusEl.innerHTML = `<div class="error-message">Erreur lors de l'analyse : ${error.message}</div>`;
            }
        }

        // Supprimer les doublons
        async function removeDuplicateAlerts() {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer les doublons d\'alertes ?')) {
                return;
            }
            
            const statusEl = document.getElementById('duplicateStatus');
            
            try {
                statusEl.innerHTML = '<div class="info-message">Suppression des doublons...</div>';
                
                // Logique de suppression des doublons
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                statusEl.innerHTML = '<div class="success-message">‚úÖ Doublons supprim√©s avec succ√®s !</div>';
                
            } catch (error) {
                statusEl.innerHTML = `<div class="error-message">Erreur : ${error.message}</div>`;
            }
        }

        // FONCTION CORRIG√âE : R√©g√©n√©rer toutes les alertes
        async function regenerateAllAlerts() {
            if (!confirm('√ätes-vous s√ªr de vouloir r√©g√©n√©rer toutes les alertes ?')) {
                return;
            }
            
            const statusEl = document.getElementById('regenerateStatus');
            
            try {
                statusEl.innerHTML = '<div class="info-message">R√©g√©n√©ration des alertes...</div>';
                
                // Effacer toutes les alertes existantes
                await clearAllAlerts();
                
                // G√©n√©rer de nouvelles alertes pour tous les contr√¥les
                const controls = await getAllControls();
                
                for (const control of controls) {
                    await generateAlertsFromControl(control.id, control);
                }
                
                const newAlerts = await getAllAlerts();
                statusEl.innerHTML = `<div class="success-message">‚úÖ ${newAlerts.length} alerte(s) r√©g√©n√©r√©e(s) !</div>`;
                
                if (document.getElementById('alertes').classList.contains('active')) {
                    await loadAlerts();
                }
                
            } catch (error) {
                statusEl.innerHTML = `<div class="error-message">Erreur : ${error.message}</div>`;
            }
        }

        // Nettoyer les alertes orphelines
        async function cleanOrphanedAlerts() {
            const statusEl = document.getElementById('cleanupStatus');
            
            try {
                statusEl.innerHTML = '<div class="info-message">Recherche des orphelins...</div>';
                
                const alerts = await getAllAlerts();
                const controls = await getAllControls();
                const controlIds = new Set(controls.map(c => c.id));
                
                const orphaned = alerts.filter(alert => 
                    alert.controlId && !controlIds.has(alert.controlId)
                );
                
                if (orphaned.length === 0) {
                    statusEl.innerHTML = '<div class="success-message">‚úÖ Aucune alerte orpheline trouv√©e !</div>';
                } else {
                    statusEl.innerHTML = `<div class="warning-message">‚ö†Ô∏è ${orphaned.length} alerte(s) orpheline(s) trouv√©e(s)</div>`;
                }
                
            } catch (error) {
                statusEl.innerHTML = `<div class="error-message">Erreur : ${error.message}</div>`;
            }
        }

        // Afficher les statistiques de la base de donn√©es
        async function showDatabaseStats() {
            const statusEl = document.getElementById('statsStatus');
            
            try {
                statusEl.innerHTML = '<div class="info-message">Calcul des statistiques...</div>';
                
                const controls = await getAllControls();
                const alerts = await getAllAlerts();
                
                const totalPhotos = controls.reduce((sum, c) => sum + (c.photos ? c.photos.length : 0), 0);
                const activeAlerts = alerts.filter(a => a.status === 'active').length;
                const resolvedAlerts = alerts.filter(a => a.status === 'resolved').length;
                
                const oldestControl = controls.length > 0 ? 
                    new Date(Math.min(...controls.map(c => new Date(c.dateControle).getTime()))).toLocaleDateString('fr-FR') : 'N/A';
                const newestControl = controls.length > 0 ? 
                    new Date(Math.max(...controls.map(c => new Date(c.dateControle).getTime()))).toLocaleDateString('fr-FR') : 'N/A';
                
                statusEl.innerHTML = `
                    <div class="info-message">
                        <h5>üìä Statistiques de la Base de Donn√©es</h5>
                        <strong>Contr√¥les :</strong> ${controls.length} enregistr√©s<br>
                        <strong>Alertes :</strong> ${alerts.length} total (${activeAlerts} actives, ${resolvedAlerts} r√©solues)<br>
                        <strong>Photos :</strong> ${totalPhotos} au total<br>
                        <strong>P√©riode des contr√¥les :</strong> du ${oldestControl} au ${newestControl}<br>
                        <strong>Derni√®re analyse :</strong> ${new Date().toLocaleString('fr-FR')}
                    </div>
                `;
                
            } catch (error) {
                statusEl.innerHTML = `<div class="error-message">Erreur lors du calcul : ${error.message}</div>`;
            }
        }

        // R√©parer la base de donn√©es
        async function repairDatabase() {
            if (!confirm('Effectuer une r√©paration de la base de donn√©es ?')) {
                return;
            }
            
            const statusEl = document.getElementById('repairStatus');
            
            try {
                statusEl.innerHTML = '<div class="info-message">R√©paration en cours...</div>';
                
                // Logique de r√©paration
                await diagnoseDuplicateAlerts();
                await cleanOrphanedAlerts();
                
                statusEl.innerHTML = '<div class="success-message">‚úÖ Base de donn√©es r√©par√©e avec succ√®s !</div>';
                
            } catch (error) {
                statusEl.innerHTML = `<div class="error-message">Erreur : ${error.message}</div>`;
            }
        }

        // === FONCTIONS UTILITAIRES ===

        function downloadJSON(data, filename) {
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = e => reject(new Error('Erreur de lecture du fichier'));
                reader.readAsText(file);
            });
        }

        function showMessage(type, message) {
            const messageEl = document.createElement('div');
            messageEl.className = `${type}-message`;
            messageEl.textContent = message;
            messageEl.style.position = 'fixed';
            messageEl.style.top = '20px';
            messageEl.style.right = '20px';
            messageEl.style.zIndex = '1000';
            messageEl.style.maxWidth = '400px';
            
            document.body.appendChild(messageEl);
            
            setTimeout(() => {
                messageEl.remove();
            }, 5000);
        }

        function updateCheckboxStyles() {
            document.querySelectorAll('.checkbox-item').forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                if (checkbox.checked) {
                    item.classList.add('checked');
                } else {
                    item.classList.remove('checked');
                }
            });
        }

        // === GESTION DES √âV√âNEMENTS ===

        document.addEventListener('change', function(e) {
            if (e.target.type === 'checkbox') {
                updateCheckboxStyles();
            }
        });

        // Fermeture modale avec Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const cameraModal = document.getElementById('cameraModal');
                if (cameraModal.style.display === 'flex') {
                    closeCamera();
                }
                
                const photoViewer = document.querySelector('.photo-viewer-modal');
                if (photoViewer) {
                    photoViewer.remove();
                }
            }
        });

        // === INITIALISATION ===

        document.addEventListener('DOMContentLoaded', async function() {
            try {
                await initDB();
                console.log('Base de donn√©es initialis√©e avec succ√®s');
                
                // Initialiser la date par d√©faut
                document.getElementById('dateControle').value = new Date().toISOString().split('T')[0];
                updatePhotoPreview();
                
                // Charger les contr√¥les initiaux
                await loadControls();
                
                // Drag & Drop setup pour import individuel
                const importSection = document.getElementById('importIndividualSection');
                if (importSection) {
                    importSection.addEventListener('dragover', function(e) {
                        e.preventDefault();
                        importSection.classList.add('drag-over');
                    });
                    
                    importSection.addEventListener('dragleave', function(e) {
                        e.preventDefault();
                        importSection.classList.remove('drag-over');
                    });
                    
                    importSection.addEventListener('drop', function(e) {
                        e.preventDefault();
                        importSection.classList.remove('drag-over');
                        
                        const files = e.dataTransfer.files;
                        if (files.length > 0) {
                            const fileInput = document.getElementById('individualControlFile');
                            fileInput.files = files;
                            handleIndividualControlFile(fileInput);
                        }
                    });
                }

                // Drag & Drop pour les v√©hicules
                const importVehicleSection = document.getElementById('importVehicleSection');
                if (importVehicleSection) {
                    importVehicleSection.addEventListener('dragover', function(e) {
                        e.preventDefault();
                        importVehicleSection.classList.add('drag-over');
                    });
                    
                    importVehicleSection.addEventListener('dragleave', function(e) {
                        e.preventDefault();
                        importVehicleSection.classList.remove('drag-over');
                    });
                    
                    importVehicleSection.addEventListener('drop', function(e) {
                        e.preventDefault();
                        importVehicleSection.classList.remove('drag-over');
                        
                        const files = e.dataTransfer.files;
                        if (files.length > 0) {
                            const fileInput = document.getElementById('vehicleListFile');
                            fileInput.files = files;
                            handleVehicleListFile(fileInput);
                        }
                    });
                }

                // Gestionnaire pour le formulaire principal
                const form = document.getElementById('vehicleForm');
                if (form) {
                    form.addEventListener('submit', async function(e) {
                        e.preventDefault();
                        
                        // Validation des champs obligatoires
                        const conducteur = document.getElementById('conducteur').value.trim();
                        const immatriculation = document.getElementById('immatriculation').value.trim();
                        const dateControle = document.getElementById('dateControle').value;
                        
                        // Validation du nom du conducteur
                        if (!conducteur) {
                            showMessage('error', 'Le nom du conducteur est obligatoire');
                            return;
                        }
                        
                        // Validation de l'immatriculation
                        if (!immatriculation) {
                            showMessage('error', 'L\'immatriculation est obligatoire');
                            return;
                        }
                        
                        if (!/^[A-Z]{2}-[0-9]{3}-[A-Z]{2}$/.test(immatriculation)) {
                            showMessage('error', 'L\'immatriculation doit √™tre au format XX-XXX-DZ (2 lettres - 3 chiffres - 2 lettres)');
                            document.getElementById('immatriculation').focus();
                            return;
                        }
                        
                        // Validation de la date
                        if (!dateControle) {
                            showMessage('error', 'La date du contr√¥le est obligatoire');
                            return;
                        }
                        
                        const formData = new FormData(this);
                        const data = {
                            conducteur: conducteur.toUpperCase(), // S'assurer que c'est en majuscules
                            dateControle: formData.get('dateControle'),
                            immatriculation: immatriculation.toUpperCase(), // S'assurer que c'est en majuscules
                            kilometrage: formData.get('kilometrage') || null,
                            prochainControle: formData.get('prochainControle') || null,
                            derniereRevision: formData.get('derniereRevision') || null,
                            
                            // Documents
                            permis: formData.has('permis'),
                            carteVerte: formData.has('carteVerte'),
                            carteGrise: formData.has('carteGrise'),
                            carteCarburant: formData.has('carteCarburant'),
                            
                            // √âquipements
                            giletJaune: formData.has('giletJaune'),
                            triangle: formData.has('triangle'),
                            roueSecours: formData.has('roueSecours'),
                            trousseSecours: formData.has('trousseSecours'),
                            
                            // √âtats
                            etatRangement: formData.get('etatRangement'),
                            propreteInterieur: formData.get('propreteInterieur'),
                            propreteExterieur: formData.get('propreteExterieur'),
                            
                            // Pneus
                            pneuAvantGauche: formData.get('pneuAvantGauche'),
                            pneuAvantDroit: formData.get('pneuAvantDroit'),
                            pneuArriereGauche: formData.get('pneuArriereGauche'),
                            pneuArriereDroit: formData.get('pneuArriereDroit'),
                            
                            // Commentaires
                            commentaires: formData.get('commentaires') || '',
                            
                            // Photos
                            photos: currentPhotos.map(photo => ({
                                id: photo.id,
                                data: photo.data,
                                timestamp: photo.timestamp
                            })),
                            
                            dateCreation: new Date().toISOString()
                        };
                        
                        try {
                            await saveControl(data);
                            showMessage('success', `Contr√¥le enregistr√© avec succ√®s ! V√©hicule ${data.immatriculation} - ${data.conducteur} (${currentPhotos.length} photo(s) incluse(s))`);
                            resetForm();
                            await loadControls();
                        } catch (error) {
                            showMessage('error', 'Erreur lors de l\'enregistrement : ' + error.message);
                        }
                    });
                }
                
            } catch (error) {
                console.error('Erreur lors de l\'initialisation:', error);
                showMessage('error', 'Erreur d\'initialisation de la base de donn√©es');
            }
        });
    </script>
</body>
</html>
